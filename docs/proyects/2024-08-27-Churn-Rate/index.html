<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Joel Burbano">

<title>Churn Rate (Tasa de Abandono) – Joel Burbano</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "Sin resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar",
    "search-label": "Buscar"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-C1J6R1KB4G"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-C1J6R1KB4G', { 'anonymize_ip': true});
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Joel Burbano</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Buscar"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Navegación de palanca" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../proyects.html"> 
<span class="menu-text">Proyectos</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../certific.html"> 
<span class="menu-text">Certificados</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../contacto.html"> 
<span class="menu-text">Contactos</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/jxbsjb"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:joelburbano@outlook.com"> <i class="bi bi-envelope" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Alternar modo oscuro"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">En esta página</h2>
   
  <ul>
  <li><a href="#importación-de-datos" id="toc-importación-de-datos" class="nav-link active" data-scroll-target="#importación-de-datos">Importación de Datos</a></li>
  <li><a href="#particionamos-la-data-en-conjuntos-train-test" id="toc-particionamos-la-data-en-conjuntos-train-test" class="nav-link" data-scroll-target="#particionamos-la-data-en-conjuntos-train-test">Particionamos la data en conjuntos Train / Test</a></li>
  <li><a href="#análisis-exploratorio" id="toc-análisis-exploratorio" class="nav-link" data-scroll-target="#análisis-exploratorio">Análisis Exploratorio</a>
  <ul class="collapse">
  <li><a href="#tipo-de-datos" id="toc-tipo-de-datos" class="nav-link" data-scroll-target="#tipo-de-datos">Tipo de datos</a></li>
  <li><a href="#cambio-de-nombres-de-las-columnas" id="toc-cambio-de-nombres-de-las-columnas" class="nav-link" data-scroll-target="#cambio-de-nombres-de-las-columnas">Cambio de nombres de las columnas</a></li>
  <li><a href="#exploración-de-datos" id="toc-exploración-de-datos" class="nav-link" data-scroll-target="#exploración-de-datos">Exploración de datos</a></li>
  <li><a href="#evaluación-de-valores-nulos" id="toc-evaluación-de-valores-nulos" class="nav-link" data-scroll-target="#evaluación-de-valores-nulos">Evaluación de valores nulos</a></li>
  <li><a href="#valores-duplicados" id="toc-valores-duplicados" class="nav-link" data-scroll-target="#valores-duplicados">Valores duplicados</a></li>
  <li><a href="#proporción-del-variable-dependiente" id="toc-proporción-del-variable-dependiente" class="nav-link" data-scroll-target="#proporción-del-variable-dependiente">Proporción del variable dependiente</a></li>
  </ul></li>
  <li><a href="#seleccion-de-variables-ks-vi" id="toc-seleccion-de-variables-ks-vi" class="nav-link" data-scroll-target="#seleccion-de-variables-ks-vi">Seleccion de Variables (KS / VI)</a></li>
  <li><a href="#creación-de-features-para-el-modelo" id="toc-creación-de-features-para-el-modelo" class="nav-link" data-scroll-target="#creación-de-features-para-el-modelo">Creación de Features para el modelo</a>
  <ul class="collapse">
  <li><a href="#creación-de-features-personalizada" id="toc-creación-de-features-personalizada" class="nav-link" data-scroll-target="#creación-de-features-personalizada">Creación de features personalizada</a>
  <ul class="collapse">
  <li><a href="#regresión-logística" id="toc-regresión-logística" class="nav-link" data-scroll-target="#regresión-logística">Regresión Logística</a></li>
  </ul></li>
  <li><a href="#optimal-binning" id="toc-optimal-binning" class="nav-link" data-scroll-target="#optimal-binning">Optimal binning</a></li>
  <li><a href="#ensamble" id="toc-ensamble" class="nav-link" data-scroll-target="#ensamble">Ensamble</a></li>
  <li><a href="#random-forest" id="toc-random-forest" class="nav-link" data-scroll-target="#random-forest">Random Forest</a></li>
  <li><a href="#gradient-boosting-machine" id="toc-gradient-boosting-machine" class="nav-link" data-scroll-target="#gradient-boosting-machine">Gradient Boosting Machine</a></li>
  <li><a href="#regresión-logística-1" id="toc-regresión-logística-1" class="nav-link" data-scroll-target="#regresión-logística-1">Regresión Logística</a></li>
  <li><a href="#ensamble-rf-gbm" id="toc-ensamble-rf-gbm" class="nav-link" data-scroll-target="#ensamble-rf-gbm">Ensamble RF + GBM</a></li>
  <li><a href="#ensamble-rf-rl" id="toc-ensamble-rf-rl" class="nav-link" data-scroll-target="#ensamble-rf-rl">Ensamble RF + RL</a></li>
  <li><a href="#predicciones" id="toc-predicciones" class="nav-link" data-scroll-target="#predicciones">Predicciones</a></li>
  <li><a href="#curva-roc-rf" id="toc-curva-roc-rf" class="nav-link" data-scroll-target="#curva-roc-rf">Curva ROC RF</a></li>
  <li><a href="#curva-roc-rl" id="toc-curva-roc-rl" class="nav-link" data-scroll-target="#curva-roc-rl">Curva ROC RL</a></li>
  <li><a href="#curva-roc-gbm" id="toc-curva-roc-gbm" class="nav-link" data-scroll-target="#curva-roc-gbm">Curva ROC GBM</a></li>
  <li><a href="#curva-roc-rf-gbm" id="toc-curva-roc-rf-gbm" class="nav-link" data-scroll-target="#curva-roc-rf-gbm">Curva ROC RF + GBM</a></li>
  <li><a href="#curva-roc-rf-rl" id="toc-curva-roc-rf-rl" class="nav-link" data-scroll-target="#curva-roc-rf-rl">Curva ROC RF + RL</a></li>
  <li><a href="#curva-roc-rl-rf-gbm" id="toc-curva-roc-rl-rf-gbm" class="nav-link" data-scroll-target="#curva-roc-rl-rf-gbm">Curva ROC RL + RF + GBM</a></li>
  </ul></li>
  <li><a href="#conclusiones" id="toc-conclusiones" class="nav-link" data-scroll-target="#conclusiones">Conclusiones</a></li>
  <li><a href="#recomendaciones" id="toc-recomendaciones" class="nav-link" data-scroll-target="#recomendaciones">Recomendaciones</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Churn Rate (Tasa de Abandono)</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Código</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Mostrar todo el código</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Ocultar todo el código</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">Ver el código fuente</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">R</div>
    <div class="quarto-category">Machine Learning</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Autor/a</div>
    <div class="quarto-title-meta-contents">
             <p>Joel Burbano </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Fecha de publicación</div>
    <div class="quarto-title-meta-contents">
      <p class="date">27 de agosto de 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>En este proyecto vamos a desarrollar un modelo predictivo para identificar clientes con alto riesgo de churn (abandono) en una institución bancaria, utilizando técnicas de Machine Learning</p>
<section id="importación-de-datos" class="level1">
<h1>Importación de Datos</h1>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Importamos las librerias</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"D:/Joel/Blog/recursos/funciones_aux.R"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"Churn_Modelling.csv"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df,<span class="dv">5</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   RowNumber CustomerId  Surname CreditScore Geography Gender   Age Tenure
       &lt;int&gt;      &lt;int&gt;   &lt;char&gt;       &lt;int&gt;    &lt;char&gt; &lt;char&gt; &lt;num&gt;  &lt;int&gt;
1:         1   15634602 Hargrave         619    France Female    42      2
2:         2   15647311     Hill         608     Spain Female    41      1
3:         3   15619304     Onio         502    France Female    42      8
4:         4   15701354     Boni         699    France Female    39      1
5:         5   15737888 Mitchell         850     Spain Female    43      2
     Balance NumOfProducts HasCrCard IsActiveMember EstimatedSalary Exited
       &lt;num&gt;         &lt;int&gt;     &lt;int&gt;          &lt;int&gt;           &lt;num&gt;  &lt;int&gt;
1:      0.00             1         1              1       101348.88      1
2:  83807.86             1         0              1       112542.58      0
3: 159660.80             3         1              0       113931.57      1
4:      0.00             2         0              0        93826.63      0
5: 125510.82             1        NA              1        79084.10      0</code></pre>
</div>
</div>
<p>breve revisión a la variable dependiente</p>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>df[, .N, by <span class="ot">=</span> Exited]</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Exited     N
    &lt;int&gt; &lt;int&gt;
1:      1  2038
2:      0  7964</code></pre>
</div>
</div>
<p>Notamos que la data esta desbalanceada con el grupo mayoritario 1 que son las personas que abandonan</p>
<ul>
<li>0 No abandona</li>
<li>1 Abandona</li>
</ul>
</section>
<section id="particionamos-la-data-en-conjuntos-train-test" class="level1">
<h1>Particionamos la data en conjuntos Train / Test</h1>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Base de modelamiento / validacion</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">95</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>marca <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df), <span class="at">size =</span> <span class="fu">floor</span>(<span class="fl">0.7</span> <span class="sc">*</span> <span class="fu">nrow</span>(df)), <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>df[, ModVal <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df)]</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>df[, ModVal <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(ModVal <span class="sc">%in%</span> marca, <span class="dv">0</span>, <span class="dv">1</span>)]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>df[, .N, by <span class="ot">=</span> ModVal]</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   ModVal     N
    &lt;num&gt; &lt;int&gt;
1:      1  3001
2:      0  7001</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df[, <span class="fu">table</span>(Exited, ModVal, <span class="at">useNA =</span> <span class="st">"always"</span>)]</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>      ModVal
Exited    0    1 &lt;NA&gt;
  0    5548 2416    0
  1    1453  585    0
  &lt;NA&gt;    0    0    0</code></pre>
</div>
</div>
</section>
<section id="análisis-exploratorio" class="level1">
<h1>Análisis Exploratorio</h1>
<section id="tipo-de-datos" class="level2">
<h2 class="anchored" data-anchor-id="tipo-de-datos">Tipo de datos</h2>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(df)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Classes 'data.table' and 'data.frame':  10002 obs. of  15 variables:
 $ RowNumber      : int  1 2 3 4 5 6 7 8 9 10 ...
 $ CustomerId     : int  15634602 15647311 15619304 15701354 15737888 15574012 15592531 15656148 15792365 15592389 ...
 $ Surname        : chr  "Hargrave" "Hill" "Onio" "Boni" ...
 $ CreditScore    : int  619 608 502 699 850 645 822 376 501 684 ...
 $ Geography      : chr  "France" "Spain" "France" "France" ...
 $ Gender         : chr  "Female" "Female" "Female" "Female" ...
 $ Age            : num  42 41 42 39 43 44 50 29 44 NA ...
 $ Tenure         : int  2 1 8 1 2 8 7 4 4 2 ...
 $ Balance        : num  0 83808 159661 0 125511 ...
 $ NumOfProducts  : int  1 1 3 2 1 2 2 4 2 1 ...
 $ HasCrCard      : int  1 0 1 0 NA 1 1 1 0 1 ...
 $ IsActiveMember : int  1 1 0 0 1 0 1 0 NA 1 ...
 $ EstimatedSalary: num  101349 112543 113932 93827 79084 ...
 $ Exited         : int  1 0 1 0 0 1 0 1 0 0 ...
 $ ModVal         : num  1 0 0 0 0 0 1 0 0 1 ...
 - attr(*, ".internal.selfref")=&lt;externalptr&gt; </code></pre>
</div>
</div>
<p>creamos una lista de variables para mejor manipulación</p>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>index <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"RowNumber"</span>, <span class="st">"CustomerId"</span>,<span class="st">"Surname"</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>var_num <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"CreditScore"</span>, <span class="st">"Age"</span>, <span class="st">"Tenure"</span>, <span class="st">"Balance"</span>,<span class="st">"EstimatedSalary"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>var_cat <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(df),<span class="fu">c</span>(index,var_num,<span class="st">"Exited"</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="cambio-de-nombres-de-las-columnas" class="level2">
<h2 class="anchored" data-anchor-id="cambio-de-nombres-de-las-columnas">Cambio de nombres de las columnas</h2>
<p>En esta ocasión no vamos a cambiar ningun nombre</p>
</section>
<section id="exploración-de-datos" class="level2">
<h2 class="anchored" data-anchor-id="exploración-de-datos">Exploración de datos</h2>
<p>Primero visualicemos un breve resumen de las variables</p>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(df)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   RowNumber       CustomerId         Surname           CreditScore   
 Min.   :    1   Min.   :15565701   Length:10002       Min.   :350.0  
 1st Qu.: 2501   1st Qu.:15628525   Class :character   1st Qu.:584.0  
 Median : 5002   Median :15690732   Mode  :character   Median :652.0  
 Mean   : 5002   Mean   :15690933                      Mean   :650.6  
 3rd Qu.: 7502   3rd Qu.:15753226                      3rd Qu.:718.0  
 Max.   :10000   Max.   :15815690                      Max.   :850.0  
                                                                      
  Geography            Gender               Age            Tenure      
 Length:10002       Length:10002       Min.   :18.00   Min.   : 0.000  
 Class :character   Class :character   1st Qu.:32.00   1st Qu.: 3.000  
 Mode  :character   Mode  :character   Median :37.00   Median : 5.000  
                                       Mean   :38.92   Mean   : 5.012  
                                       3rd Qu.:44.00   3rd Qu.: 7.000  
                                       Max.   :92.00   Max.   :10.000  
                                       NA's   :1                       
    Balance       NumOfProducts    HasCrCard      IsActiveMember  
 Min.   :     0   Min.   :1.00   Min.   :0.0000   Min.   :0.0000  
 1st Qu.:     0   1st Qu.:1.00   1st Qu.:0.0000   1st Qu.:0.0000  
 Median : 97199   Median :1.00   Median :1.0000   Median :1.0000  
 Mean   : 76491   Mean   :1.53   Mean   :0.7055   Mean   :0.5149  
 3rd Qu.:127648   3rd Qu.:2.00   3rd Qu.:1.0000   3rd Qu.:1.0000  
 Max.   :250898   Max.   :4.00   Max.   :1.0000   Max.   :1.0000  
                                 NA's   :1        NA's   :1       
 EstimatedSalary         Exited           ModVal   
 Min.   :    11.58   Min.   :0.0000   Min.   :0.0  
 1st Qu.: 50983.75   1st Qu.:0.0000   1st Qu.:0.0  
 Median :100185.24   Median :0.0000   Median :0.0  
 Mean   :100083.33   Mean   :0.2038   Mean   :0.3  
 3rd Qu.:149383.65   3rd Qu.:0.0000   3rd Qu.:1.0  
 Max.   :199992.48   Max.   :1.0000   Max.   :1.0  
                                                   </code></pre>
</div>
</div>
<p>Notamos que existen valores perdidos o NA’s, los mismos que serán tratados mas adelante</p>
</section>
<section id="evaluación-de-valores-nulos" class="level2">
<h2 class="anchored" data-anchor-id="evaluación-de-valores-nulos">Evaluación de valores nulos</h2>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tratamiento NA's </span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df[<span class="sc">!</span>(<span class="fu">is.na</span>(HasCrCard) <span class="sc">==</span> <span class="cn">TRUE</span>),]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df[<span class="sc">!</span>(<span class="fu">is.na</span>(IsActiveMember) <span class="sc">==</span> <span class="cn">TRUE</span>),]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df[<span class="sc">!</span>(<span class="fu">is.na</span>(Age) <span class="sc">==</span> <span class="cn">TRUE</span>),]</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(df))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
</section>
<section id="valores-duplicados" class="level2">
<h2 class="anchored" data-anchor-id="valores-duplicados">Valores duplicados</h2>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">unique</span>(df)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="proporción-del-variable-dependiente" class="level2">
<h2 class="anchored" data-anchor-id="proporción-del-variable-dependiente">Proporción del variable dependiente</h2>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>df[, <span class="fu">round</span>(.N <span class="sc">/</span> <span class="fu">nrow</span>(df),<span class="dv">3</span>), by <span class="ot">=</span> Exited]</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Exited    V1
    &lt;int&gt; &lt;num&gt;
1:      1 0.204
2:      0 0.796</code></pre>
</div>
</div>
</section>
</section>
<section id="seleccion-de-variables-ks-vi" class="level1">
<h1>Seleccion de Variables (KS / VI)</h1>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># KS VI</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Sujetos buenos y malos para calculo de KS</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> df[ModVal <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> Exited <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)]</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>val <span class="ot">&lt;-</span> df[ModVal <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># identificación de variables con alto porcentaje de NA's</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>porc <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">sapply</span>(mod, porcNA), <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>PorcentajeNA <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">names</span>(porc), <span class="fu">as.numeric</span>(porc))</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(PorcentajeNA) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Var"</span>, <span class="st">"Por"</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>dvars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">colnames</span>(mod), <span class="fu">names</span>(porc)[porc <span class="sc">&gt;</span> <span class="fl">0.3</span>])</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co"># tratamiento NA's </span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df[<span class="sc">!</span>(<span class="fu">is.na</span>(HasCrCard) <span class="sc">==</span> <span class="cn">TRUE</span>),]</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df[<span class="sc">!</span>(<span class="fu">is.na</span>(IsActiveMember) <span class="sc">==</span> <span class="cn">TRUE</span>),]</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> df[ModVal <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> Exited <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)]</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>val <span class="ot">&lt;-</span> df[ModVal <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Identificación de variables constantes</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>dvars <span class="ot">&lt;-</span> dvars[<span class="sc">!</span><span class="fu">unname</span>(<span class="fu">unlist</span>(<span class="fu">sapply</span>(mod[,dvars, <span class="at">with =</span> <span class="cn">FALSE</span>], constante)))]</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejecución de KS &amp; VI</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>vnum <span class="ot">&lt;-</span> <span class="fu">colnames</span>(mod)[<span class="fu">unname</span>(<span class="fu">sapply</span>(mod, class)) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"numeric"</span>, <span class="st">"integer"</span>) ]</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>vcat <span class="ot">&lt;-</span> <span class="fu">colnames</span>(mod)[<span class="fu">unname</span>(<span class="fu">sapply</span>(mod, class)) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"character"</span>, <span class="st">"logical"</span>)]</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>dnum <span class="ot">&lt;-</span> mod[, vnum, with <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>dcat <span class="ot">&lt;-</span> mod[, vcat, with <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>VI <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">sapply</span>(dcat, TestVI, <span class="at">y =</span> mod<span class="sc">$</span>Exited), <span class="at">decreasing =</span> T)</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>dVI <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">names</span>(VI), VI)</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(dVI) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Variable"</span>, <span class="st">"VI"</span>); <span class="fu">rownames</span>(dVI) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>dVI</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Variable          VI
1 Geography  0.17789046
2    Gender  0.05744401
3   Surname -0.03811443</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculo de KS sobre variables numericas</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>KS <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">seq_along</span>(dnum), <span class="cf">function</span>(i){<span class="fu">TestKS</span>(dnum[[i]], mod<span class="sc">$</span>Exited)})</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>dKS <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">colnames</span>(dnum), KS); dKS <span class="ot">&lt;-</span> dKS[<span class="fu">order</span>(dKS<span class="sc">$</span>KS, <span class="at">decreasing =</span> <span class="cn">TRUE</span>),]</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(dKS) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Variable"</span>, <span class="st">"KS"</span>); <span class="fu">rownames</span>(dKS) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>dKS</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          Variable     KS
1           Exited 1.0000
2              Age 0.3790
3    NumOfProducts 0.2163
4   IsActiveMember 0.1945
5          Balance 0.1528
6      CreditScore 0.0460
7       CustomerId 0.0222
8        RowNumber 0.0217
9  EstimatedSalary 0.0208
10          Tenure 0.0169
11       HasCrCard 0.0089
12          ModVal 0.0000</code></pre>
</div>
</div>
<p>Seleccionamos las variables con valores altos de KS / VI</p>
</section>
<section id="creación-de-features-para-el-modelo" class="level1">
<h1>Creación de Features para el modelo</h1>
<section id="creación-de-features-personalizada" class="level2">
<h2 class="anchored" data-anchor-id="creación-de-features-personalizada">Creación de features personalizada</h2>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Construcción de variables y discretización </span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>df[,prbm_NumOfProducts <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(NumOfProducts <span class="sc">&lt;</span> <span class="fl">1.5</span>, <span class="fl">0.2776061</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">ifelse</span>(NumOfProducts <span class="sc">&lt;</span> <span class="fl">2.5</span>, <span class="fl">0.0800000</span>, <span class="fl">0.8744770</span>))]</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>df[,prbm_Age <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(Age <span class="sc">&lt;</span> <span class="fl">42.5</span>, <span class="fl">0.1208350</span>,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">ifelse</span>(Age <span class="sc">&lt;</span> <span class="fl">46.5</span>, <span class="fl">0.3450704</span>,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">ifelse</span>(Age <span class="sc">&lt;</span> <span class="fl">57.5</span>, <span class="fl">0.5261364</span>, <span class="fl">0.3356808</span>)))]</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>df[, prbm_IsActiveMember <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(IsActiveMember <span class="sc">&lt;</span> <span class="fl">0.5</span>, <span class="fl">0.1451298</span>,<span class="fl">0.2732064</span>)]</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>df[, prbm_Geography <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(Geography <span class="sc">==</span> <span class="st">"France"</span>, <span class="fl">0.1667147</span>,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">ifelse</span>(Geography <span class="sc">==</span> <span class="st">"Spain"</span>,<span class="fl">0.1624077</span>, <span class="fl">0.3327684</span>))]</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>df[, prbm_Balance <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(Balance <span class="sc">&lt;</span> <span class="fl">1884.5</span>, <span class="fl">0.1368209</span>, <span class="fl">0.2466209</span>)]</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>df[, prbm_Gender <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(Gender <span class="sc">==</span> <span class="st">"Male"</span>, <span class="fl">0.1714436</span> , <span class="fl">0.2507042</span>)]</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>df[, prbm_CreditScore <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(CreditScore <span class="sc">&lt;=</span> <span class="fl">407.5</span>, <span class="fl">0.94444444</span> ,<span class="fl">0.20573066</span>)]</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>df[, prbm_EstimatedSalary <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(EstimatedSalary <span class="sc">&lt;=</span> <span class="dv">25000</span>, <span class="fl">0.2031063</span>,</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>                                    <span class="fu">ifelse</span>(EstimatedSalary <span class="sc">&lt;=</span> <span class="dv">35000</span>, <span class="fl">0.2156863</span>,</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>                                           <span class="fu">ifelse</span>(EstimatedSalary <span class="sc">&lt;=</span> <span class="dv">60000</span>, <span class="fl">0.1944134</span>,</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>                                                  <span class="fu">ifelse</span>(EstimatedSalary <span class="sc">&lt;=</span> <span class="dv">75000</span>, <span class="fl">0.2189239</span>,</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(EstimatedSalary <span class="sc">&lt;=</span> <span class="dv">85000</span>, <span class="fl">0.1789474</span>,</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>                                                                <span class="fu">ifelse</span>(EstimatedSalary <span class="sc">&lt;=</span> <span class="dv">155000</span>, <span class="fl">0.1990913</span>,</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>                                                                       <span class="fu">ifelse</span>(EstimatedSalary <span class="sc">&lt;=</span> <span class="dv">185000</span>, <span class="fl">0.2301815</span>, <span class="fl">0.1965649</span>))))))  )]</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Generación de muestras para el performance del modelo</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> df[ModVal <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> Exited <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)]</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>val <span class="ot">&lt;-</span> df[ModVal <span class="sc">==</span><span class="dv">1</span>]</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="regresión-logística" class="level3">
<h3 class="anchored" data-anchor-id="regresión-logística">Regresión Logística</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Regresión logistica</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> <span class="st">"Exited ~</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="st">  prbm_NumOfProducts +</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="st">  prbm_Age +</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="st">  prbm_IsActiveMember +</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="st">  prbm_Geography + </span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="st">  prbm_Gender +</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="st">  prbm_EstimatedSalary</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="at">formula =</span> <span class="fu">as.formula</span>(formula), <span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">"logit"</span>), <span class="at">data =</span> mod)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelo)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = as.formula(formula), family = binomial("logit"), 
    data = mod)

Coefficients:
                     Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)           -6.1860     0.6008 -10.296  &lt; 2e-16 ***
prbm_NumOfProducts     6.1156     0.2780  22.002  &lt; 2e-16 ***
prbm_Age               5.5137     0.2196  25.113  &lt; 2e-16 ***
prbm_IsActiveMember   -7.6616     0.5742 -13.343  &lt; 2e-16 ***
prbm_Geography         5.2643     0.4509  11.674  &lt; 2e-16 ***
prbm_Gender            5.9177     0.9004   6.572 4.95e-11 ***
prbm_EstimatedSalary   6.3426     2.5981   2.441   0.0146 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 7149.2  on 6997  degrees of freedom
Residual deviance: 5134.2  on 6991  degrees of freedom
AIC: 5148.2

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>nom_vars <span class="ot">&lt;-</span> <span class="fu">all.vars</span>(<span class="fu">terms</span>(modelo))[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">cor</span>(<span class="fu">setDT</span>(mod)[, ..nom_vars])</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>res</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                     prbm_NumOfProducts   prbm_Age prbm_IsActiveMember
prbm_NumOfProducts          1.000000000 0.14015906         -0.03921337
prbm_Age                    0.140159055 1.00000000          0.02311527
prbm_IsActiveMember        -0.039213366 0.02311527          1.00000000
prbm_Geography              0.076511468 0.06275108         -0.02691362
prbm_Gender                 0.031159138 0.03948541         -0.02861081
prbm_EstimatedSalary        0.004809131 0.01098787         -0.01646802
                     prbm_Geography  prbm_Gender prbm_EstimatedSalary
prbm_NumOfProducts       0.07651147  0.031159138          0.004809131
prbm_Age                 0.06275108  0.039485408          0.010987871
prbm_IsActiveMember     -0.02691362 -0.028610806         -0.016468018
prbm_Geography           1.00000000  0.019422000          0.015802201
prbm_Gender              0.01942200  1.000000000         -0.009303946
prbm_EstimatedSalary     0.01580220 -0.009303946          1.000000000</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">eigen</span>(res)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>eigen() decomposition
$values
[1] 1.2103689 1.0254641 1.0085638 0.9703447 0.9400960 0.8451624

$vectors
            [,1]        [,2]        [,3]       [,4]        [,5]        [,6]
[1,] -0.61329773  0.07464562  0.01739220  0.1542000  0.37626626  0.67278339
[2,] -0.57690639  0.36902613  0.06410691 -0.1439743  0.24002392 -0.66973797
[3,]  0.14872209  0.82019845  0.15353299 -0.3083363 -0.31987004  0.29016501
[4,] -0.44372704 -0.11890199  0.16319040  0.3516848 -0.79861501 -0.02948562
[5,] -0.25687639 -0.22070837 -0.60816689 -0.6674430 -0.24617892  0.09670143
[6,] -0.07776557 -0.35024616  0.75862861 -0.5396852  0.01026557  0.06631192</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>( <span class="fu">head</span>(<span class="fu">eigen</span>(res)<span class="sc">$</span>values,<span class="dv">1</span>) <span class="sc">/</span> <span class="fu">tail</span>(<span class="fu">eigen</span>(res)<span class="sc">$</span>values,<span class="dv">1</span>)) <span class="co"># calculo IC &gt; 5 indicios multicolinealidad</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.19671</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>df[, Y<span class="sc">:</span><span class="er">=</span> modelo<span class="sc">$</span>coefficients[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">Reduce</span>(<span class="st">`</span><span class="at">+</span><span class="st">`</span>, <span class="fu">Map</span>(<span class="cf">function</span>(var, coef) <span class="fu">get</span>(var) <span class="sc">*</span> coef, <span class="fu">names</span>(modelo<span class="sc">$</span>coefficients[<span class="sc">-</span><span class="dv">1</span>]), modelo<span class="sc">$</span>coefficients[<span class="sc">-</span><span class="dv">1</span>]))]</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>df[, RL <span class="sc">:</span><span class="er">=</span> (<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(Y)))]</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co">#quantile(df$RL, probs = seq(0 , 1, by = 0.01), na.rm = TRUE)</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> df[ModVal <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> Exited <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)]</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>val <span class="ot">&lt;-</span> df[ModVal <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimación  Probabilidades</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>res_mod <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">Var =</span> mod<span class="sc">$</span>Exited, <span class="at">RL =</span> mod<span class="sc">$</span>RL)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>res_val <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">Var =</span> val<span class="sc">$</span>Exited, <span class="at">RL =</span> val<span class="sc">$</span>RL)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Gráficas ROC</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>objroc1 <span class="ot">&lt;-</span> <span class="fu">roc</span>(res_mod<span class="sc">$</span>Var, res_mod<span class="sc">$</span>RL, <span class="at">auc=</span>T, <span class="at">ci=</span>T)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(objroc1, <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">xlab=</span><span class="st">"1 - Especificidad"</span>, <span class="at">ylab=</span><span class="st">"Sensibilidad"</span>, <span class="at">main=</span><span class="st">"Comparación curvas ROC"</span>, <span class="at">legacy.axes =</span> <span class="cn">TRUE</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>objroc2 <span class="ot">&lt;-</span> <span class="fu">roc</span>(res_val<span class="sc">$</span>Var, res_val<span class="sc">$</span>RL, <span class="at">auc=</span>T, <span class="at">ci=</span>T)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(objroc2, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomright"</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"Modelamiento"</span>,<span class="fu">round</span>(objroc1<span class="sc">$</span>auc, <span class="dv">3</span>)), <span class="fu">paste</span>(<span class="st">"Validación"</span>, <span class="fu">round</span>(objroc2<span class="sc">$</span>auc, <span class="dv">3</span>))), <span class="at">col=</span><span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>), <span class="at">lwd=</span><span class="fl">0.5</span>, <span class="at">title =</span> <span class="st">"AUC-ROC"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">#legend("topright", legend = c(round(objroc1$auc, 3), round(objroc2$auc, 3)), col = c("blue", "red"), lwd = 0.2 , title = "AUC-ROC")</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Con estas features se ha alcanzado un AUC-ROC con la data de validación de 0.846</p>
</section>
</section>
<section id="optimal-binning" class="level2">
<h2 class="anchored" data-anchor-id="optimal-binning">Optimal binning</h2>
<p>Creando los features y bins con la libreria <code>scorecard</code></p>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("scorecard")</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scorecard)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"NumOfProducts"</span>, <span class="st">"Age"</span>, <span class="st">"IsActiveMember"</span>, <span class="st">"Geography"</span>, <span class="st">"Gender"</span>, <span class="st">"EstimatedSalary"</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>bins <span class="ot">&lt;-</span> <span class="fu">woebin</span>(df, <span class="at">y =</span> <span class="st">"Exited"</span>, <span class="at">x =</span> vars)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✔ Binning on 9998 rows and 7 columns in 00:00:02</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(bins)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$NumOfProducts
        variable      bin count count_distr   neg   pos   posprob        woe
          &lt;char&gt;   &lt;char&gt; &lt;int&gt;       &lt;num&gt; &lt;int&gt; &lt;int&gt;     &lt;num&gt;      &lt;num&gt;
1: NumOfProducts [-Inf,2)  5082   0.5083017  3673  1409 0.2772530  0.4043315
2: NumOfProducts [2, Inf)  4916   0.4916983  4287   629 0.1279496 -0.5567511
       bin_iv  total_iv breaks is_special_values
        &lt;num&gt;     &lt;num&gt; &lt;char&gt;            &lt;lgcl&gt;
1: 0.09296873 0.2209836      2             FALSE
2: 0.12801486 0.2209836    Inf             FALSE

$Age
   variable       bin count count_distr   neg   pos   posprob        woe
     &lt;char&gt;    &lt;char&gt; &lt;int&gt;       &lt;num&gt; &lt;int&gt; &lt;int&gt;     &lt;num&gt;      &lt;num&gt;
1:      Age [-Inf,35)  3678  0.36787357  3388   290 0.0788472 -1.0956541
2:      Age   [35,42)  3106  0.31066213  2641   465 0.1497102 -0.3744154
3:      Age   [42,45)   874  0.08741748   635   239 0.2734554  0.3852986
4:      Age [45, Inf)  2340  0.23404681  1296  1044 0.4461538  1.1462370
       bin_iv  total_iv breaks is_special_values
        &lt;num&gt;     &lt;num&gt; &lt;char&gt;            &lt;lgcl&gt;
1: 0.31043361 0.7642339     35             FALSE
2: 0.03879657 0.7642339     42             FALSE
3: 0.01444791 0.7642339     45             FALSE
4: 0.40055578 0.7642339    Inf             FALSE

$IsActiveMember
         variable      bin count count_distr   neg   pos   posprob        woe
           &lt;char&gt;   &lt;char&gt; &lt;int&gt;       &lt;num&gt; &lt;int&gt; &lt;int&gt;     &lt;num&gt;      &lt;num&gt;
1: IsActiveMember [-Inf,1)  4850    0.485097  3547  1303 0.2686598  0.3610272
2: IsActiveMember [1, Inf)  5148    0.514903  4413   735 0.1427739 -0.4299794
       bin_iv total_iv breaks is_special_values
        &lt;num&gt;    &lt;num&gt; &lt;char&gt;            &lt;lgcl&gt;
1: 0.06994876 0.153257      1             FALSE
2: 0.08330821 0.153257    Inf             FALSE

$Geography
    variable              bin count count_distr   neg   pos   posprob
      &lt;char&gt;           &lt;char&gt; &lt;int&gt;       &lt;num&gt; &lt;int&gt; &lt;int&gt;     &lt;num&gt;
1: Geography France%,%missing  5012   0.5013003  4202   810 0.1616121
2: Geography            Spain  2476   0.2476495  2063   413 0.1668013
3: Geography          Germany  2510   0.2510502  1695   815 0.3247012
          woe     bin_iv  total_iv           breaks is_special_values
        &lt;num&gt;      &lt;num&gt;     &lt;num&gt;           &lt;char&gt;            &lt;lgcl&gt;
1: -0.2838216 0.03702196 0.1687521 France%,%missing             FALSE
2: -0.2460089 0.01390472 0.1687521            Spain             FALSE
3:  0.6302102 0.11782546 0.1687521          Germany             FALSE

$Gender
   variable    bin count count_distr   neg   pos   posprob        woe
     &lt;char&gt; &lt;char&gt; &lt;int&gt;       &lt;num&gt; &lt;int&gt; &lt;int&gt;     &lt;num&gt;      &lt;num&gt;
1:   Gender   Male  5456   0.5457091  4557   899 0.1647727 -0.2606767
2:   Gender Female  4542   0.4542909  3403  1139 0.2507706  0.2679534
       bin_iv   total_iv breaks is_special_values
        &lt;num&gt;      &lt;num&gt; &lt;char&gt;            &lt;lgcl&gt;
1: 0.03424476 0.06944544   Male             FALSE
2: 0.03520068 0.06944544 Female             FALSE

$EstimatedSalary
          variable             bin count count_distr   neg   pos   posprob
            &lt;char&gt;          &lt;char&gt; &lt;int&gt;       &lt;num&gt; &lt;int&gt; &lt;int&gt;     &lt;num&gt;
1: EstimatedSalary    [-Inf,25000)  1217  0.12172434   975   242 0.1988496
2: EstimatedSalary   [25000,35000)   501  0.05011002   388   113 0.2255489
3: EstimatedSalary   [35000,60000)  1243  0.12432486  1013   230 0.1850362
4: EstimatedSalary   [60000,75000)   759  0.07591518   589   170 0.2239789
5: EstimatedSalary   [75000,85000)   523  0.05231046   436    87 0.1663480
6: EstimatedSalary  [85000,155000)  3519  0.35197039  2807   712 0.2023302
7: EstimatedSalary [155000,185000)  1499  0.14992999  1166   333 0.2221481
8: EstimatedSalary   [185000, Inf)   737  0.07371474   586   151 0.2048847
            woe       bin_iv    total_iv breaks is_special_values
          &lt;num&gt;        &lt;num&gt;       &lt;num&gt; &lt;char&gt;            &lt;lgcl&gt;
1: -0.031039680 1.161992e-04 0.008733362  25000             FALSE
2:  0.128842544 8.636055e-04 0.008733362  35000             FALSE
3: -0.120132130 1.730571e-03 0.008733362  60000             FALSE
4:  0.119832318 1.128837e-03 0.008733362  75000             FALSE
5: -0.249274060 3.012467e-03 0.008733362  85000             FALSE
6: -0.009333600 3.057754e-05 0.008733362 155000             FALSE
7:  0.109268188 1.848061e-03 0.008733362 185000             FALSE
8:  0.006420112 3.044140e-06 0.008733362    Inf             FALSE</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>df_bineed <span class="ot">&lt;-</span> <span class="fu">woebin_ply</span>(df,<span class="at">bins =</span> bins)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✔ Woe transformating on 9998 rows and 6 columns in 00:00:01</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_bineed, <span class="dv">5</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   RowNumber CustomerId  Surname CreditScore Tenure   Balance HasCrCard Exited
       &lt;int&gt;      &lt;int&gt;   &lt;char&gt;       &lt;int&gt;  &lt;int&gt;     &lt;num&gt;     &lt;int&gt;  &lt;int&gt;
1:         1   15634602 Hargrave         619      2      0.00         1      1
2:         2   15647311     Hill         608      1  83807.86         0      0
3:         3   15619304     Onio         502      8 159660.80         1      1
4:         4   15701354     Boni         699      1      0.00         0      0
5:         6   15574012      Chu         645      8 113755.78         1      1
   ModVal prbm_NumOfProducts  prbm_Age prbm_IsActiveMember prbm_Geography
    &lt;num&gt;              &lt;num&gt;     &lt;num&gt;               &lt;num&gt;          &lt;num&gt;
1:      1          0.2776061 0.1208350           0.2732064      0.1667147
2:      0          0.2776061 0.1208350           0.2732064      0.1624077
3:      0          0.8744770 0.1208350           0.1451298      0.1667147
4:      0          0.0800000 0.1208350           0.1451298      0.1667147
5:      0          0.0800000 0.3450704           0.1451298      0.1624077
   prbm_Balance prbm_Gender prbm_CreditScore prbm_EstimatedSalary         Y
          &lt;num&gt;       &lt;num&gt;            &lt;num&gt;                &lt;num&gt;     &lt;num&gt;
1:    0.1368209   0.2507042        0.2057307            0.1990913 -2.291211
2:    0.2466209   0.2507042        0.2057307            0.1990913 -2.313884
3:    0.2466209   0.2507042        0.2057307            0.1990913  2.340290
4:    0.1368209   0.2507042        0.2057307            0.1990913 -2.518418
5:    0.2466209   0.1714436        0.2057307            0.1990913 -1.773778
           RL NumOfProducts_woe    Age_woe IsActiveMember_woe Geography_woe
        &lt;num&gt;             &lt;num&gt;      &lt;num&gt;              &lt;num&gt;         &lt;num&gt;
1: 0.90814650         0.4043315  0.3852986         -0.4299794    -0.2838216
2: 0.91002041         0.4043315 -0.3744154         -0.4299794    -0.2460089
3: 0.08784071        -0.5567511  0.3852986          0.3610272    -0.2838216
4: 0.92542293        -0.5567511 -0.3744154          0.3610272    -0.2838216
5: 0.85492687        -0.5567511  0.3852986          0.3610272    -0.2460089
   Gender_woe EstimatedSalary_woe
        &lt;num&gt;               &lt;num&gt;
1:  0.2679534          -0.0093336
2:  0.2679534          -0.0093336
3:  0.2679534          -0.0093336
4:  0.2679534          -0.0093336
5: -0.2606767          -0.0093336</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generación de muestras para el performance del modelo</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> df_bineed[ModVal <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> Exited <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)]</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>val <span class="ot">&lt;-</span> df_bineed[ModVal <span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Regresión logistica</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> <span class="st">"Exited ~</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="st">  NumOfProducts_woe +</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="st">  Age_woe +</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="st">  IsActiveMember_woe +</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="st">  Geography_woe + </span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="st">  Gender_woe +</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="st">  EstimatedSalary_woe</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="at">formula =</span> <span class="fu">as.formula</span>(formula), <span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">"logit"</span>), <span class="at">data =</span> mod)</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelo)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = as.formula(formula), family = binomial("logit"), 
    data = mod)

Coefficients:
                    Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)         -1.32127    0.03436 -38.457  &lt; 2e-16 ***
NumOfProducts_woe    0.88080    0.07163  12.297  &lt; 2e-16 ***
Age_woe              1.03291    0.03853  26.806  &lt; 2e-16 ***
IsActiveMember_woe   1.23838    0.08731  14.184  &lt; 2e-16 ***
Geography_woe        0.99349    0.07884  12.602  &lt; 2e-16 ***
Gender_woe           0.86631    0.12656   6.845 7.65e-12 ***
EstimatedSalary_woe  0.77650    0.35711   2.174   0.0297 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 7149.2  on 6997  degrees of freedom
Residual deviance: 5690.5  on 6991  degrees of freedom
AIC: 5704.5

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>nom_vars <span class="ot">&lt;-</span> <span class="fu">all.vars</span>(<span class="fu">terms</span>(modelo))[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">cor</span>(<span class="fu">setDT</span>(mod)[, ..nom_vars])</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>res</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                    NumOfProducts_woe      Age_woe IsActiveMember_woe
NumOfProducts_woe        1.0000000000  0.077205537         0.02528692
Age_woe                  0.0772055374  1.000000000        -0.03600072
IsActiveMember_woe       0.0252869155 -0.036000718         1.00000000
Geography_woe            0.0362993628  0.062453734         0.02570862
Gender_woe              -0.0051035218  0.041384541         0.02861081
EstimatedSalary_woe     -0.0002743988 -0.000688623         0.02210737
                    Geography_woe   Gender_woe EstimatedSalary_woe
NumOfProducts_woe      0.03629936 -0.005103522       -0.0002743988
Age_woe                0.06245373  0.041384541       -0.0006886230
IsActiveMember_woe     0.02570862  0.028610806        0.0221073663
Geography_woe          1.00000000  0.018463506        0.0163394609
Gender_woe             0.01846351  1.000000000       -0.0015705987
EstimatedSalary_woe    0.01633946 -0.001570599        1.0000000000</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">eigen</span>(res)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>eigen() decomposition
$values
[1] 1.1293676 1.0415320 1.0050447 0.9873191 0.9563795 0.8803571

$vectors
            [,1]        [,2]        [,3]       [,4]        [,5]        [,6]
[1,] -0.51994721 -0.08399426  0.35618599 -0.4434461  0.43423271  0.45883434
[2,] -0.61446110 -0.35014917 -0.06401573  0.1887344  0.14251679 -0.66317673
[3,] -0.10513934  0.75866654 -0.02132252 -0.4742214  0.01207762 -0.43345625
[4,] -0.51162371  0.15684900  0.08886514  0.1162957 -0.79514618  0.24486818
[5,] -0.27141610  0.23627091 -0.81765353  0.1930863  0.25525188  0.31546188
[6,] -0.07491766  0.46296874  0.43832016  0.7014570  0.30589882  0.04802835</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>( <span class="fu">head</span>(<span class="fu">eigen</span>(res)<span class="sc">$</span>values,<span class="dv">1</span>) <span class="sc">/</span> <span class="fu">tail</span>(<span class="fu">eigen</span>(res)<span class="sc">$</span>values,<span class="dv">1</span>)) <span class="co"># calculo IC &gt; 5 indicios multicolinealidad</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.13263</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>df_bineed[, Y<span class="sc">:</span><span class="er">=</span> modelo<span class="sc">$</span>coefficients[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">Reduce</span>(<span class="st">`</span><span class="at">+</span><span class="st">`</span>, <span class="fu">Map</span>(<span class="cf">function</span>(var, coef) <span class="fu">get</span>(var) <span class="sc">*</span> coef, <span class="fu">names</span>(modelo<span class="sc">$</span>coefficients[<span class="sc">-</span><span class="dv">1</span>]), modelo<span class="sc">$</span>coefficients[<span class="sc">-</span><span class="dv">1</span>]))]</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>df_bineed[, RL <span class="sc">:</span><span class="er">=</span> (<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(Y)))]</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="co">#quantile(df_bineed$RL, probs = seq(0 , 1, by = 0.01))</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> df_bineed[ModVal <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> Exited <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)]</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>val <span class="ot">&lt;-</span> df_bineed[ModVal <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimación  Probabilidades</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>res_mod <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">Var =</span> mod<span class="sc">$</span>Exited, <span class="at">RL =</span> mod<span class="sc">$</span>RL)</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>res_val <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">Var =</span> val<span class="sc">$</span>Exited, <span class="at">RL =</span> val<span class="sc">$</span>RL)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Gráficas ROC</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="co">#library(pROC)</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>objroc1 <span class="ot">&lt;-</span> <span class="fu">roc</span>(res_mod<span class="sc">$</span>Var, res_mod<span class="sc">$</span>RL, <span class="at">auc=</span>T, <span class="at">ci=</span>T)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(objroc1, <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">xlab=</span><span class="st">"1 - Especificidad"</span>, <span class="at">ylab=</span><span class="st">"Sensibilidad"</span>, <span class="at">main=</span><span class="st">"Comparación curvas ROC"</span>, <span class="at">legacy.axes =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>objroc2 <span class="ot">&lt;-</span> <span class="fu">roc</span>(res_val<span class="sc">$</span>Var, res_val<span class="sc">$</span>RL, <span class="at">auc=</span>T, <span class="at">ci=</span>T)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(objroc2, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomright"</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"Modelamiento"</span>,<span class="fu">round</span>(objroc1<span class="sc">$</span>auc, <span class="dv">3</span>)), <span class="fu">paste</span>(<span class="st">"Validación"</span>, <span class="fu">round</span>(objroc2<span class="sc">$</span>auc, <span class="dv">3</span>))), <span class="at">col=</span><span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>), <span class="at">lwd=</span><span class="fl">0.5</span>, <span class="at">title =</span> <span class="st">"AUC-ROC"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Con la librería <code>scorecard</code> se ha alcanzado un AUC-ROC de validación de 0.815</p>
</section>
<section id="ensamble" class="level2">
<h2 class="anchored" data-anchor-id="ensamble">Ensamble</h2>
<p>Creamos y damos formato necesario para utilizar <code>h2o</code>, nota en esta ocasión trabajaremos con las variables binneadas de forma personalizada</p>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejecución del Ensamble</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(h2o)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="fu">h2o.init</span>(<span class="at">ip =</span> <span class="st">"localhost"</span>, <span class="at">nthreads =</span> <span class="dv">2</span>, <span class="at">max_mem_size =</span> <span class="st">"5G"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> Connection successful!

R is connected to the H2O cluster: 
    H2O cluster uptime:         28 minutes 41 seconds 
    H2O cluster timezone:       America/Guayaquil 
    H2O data parsing timezone:  UTC 
    H2O cluster version:        3.44.0.3 
    H2O cluster version age:    8 months and 13 days 
    H2O cluster name:           H2O_started_from_R_joelb_nrn194 
    H2O cluster total nodes:    1 
    H2O cluster total memory:   4.91 GB 
    H2O cluster total cores:    8 
    H2O cluster allowed cores:  2 
    H2O cluster healthy:        TRUE 
    H2O Connection ip:          localhost 
    H2O Connection port:        54321 
    H2O Connection proxy:       NA 
    H2O Internal Security:      FALSE 
    R Version:                  R version 4.3.3 (2024-02-29 ucrt) </code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Establecemos los datos en el formato adecuado</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Exited"</span>, <span class="st">"prbm_NumOfProducts"</span>, <span class="st">"prbm_Age"</span>, <span class="st">"prbm_IsActiveMember"</span>, <span class="st">"prbm_Geography"</span>, <span class="st">"prbm_Gender"</span>, <span class="st">"prbm_EstimatedSalary"</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>mod_em <span class="ot">&lt;-</span> <span class="fu">as.h2o</span>(<span class="at">x =</span> <span class="fu">setDT</span>(mod)[, vars, <span class="at">with =</span> <span class="cn">FALSE</span>])</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identificamos predictores y respuesta</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>y_em <span class="ot">&lt;-</span> <span class="st">"Exited"</span>; x_em <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(mod_em), y_em)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Para la clasificación binaria, la respuesta debe ser un factor </span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>mod_em[,y_em] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(mod_em[,y_em])</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Numero de CV folds </span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>nfolds <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Generaremos el ensamble con 3 modelos (RF + GLM + GBM)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="random-forest" class="level2">
<h2 class="anchored" data-anchor-id="random-forest">Random Forest</h2>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train &amp; Cross- validate a RF</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>my_rf <span class="ot">&lt;-</span> <span class="fu">h2o.randomForest</span>(<span class="at">x =</span> x_em,</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">y =</span> y_em,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">model_id =</span> <span class="st">"RF"</span>,</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">training_frame =</span> mod_em,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">ntrees =</span> <span class="dv">300</span>,</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">min_rows =</span> <span class="dv">50</span>,</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>                          <span class="at">mtries =</span> <span class="dv">5</span>,</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">nfolds =</span> nfolds,</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">fold_assignment =</span> <span class="st">"Stratified"</span>,</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>                          <span class="at">keep_cross_validation_predictions =</span> <span class="cn">TRUE</span>,</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>                          <span class="at">seed =</span> <span class="dv">95</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |====                                                                  |   5%
  |                                                                            
  |=========                                                             |  12%
  |                                                                            
  |=======================                                               |  33%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |==================================                                    |  49%
  |                                                                            
  |================================================                      |  68%
  |                                                                            
  |===================================================                   |  73%
  |                                                                            
  |==========================================================            |  83%
  |                                                                            
  |===============================================================       |  91%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">h2o.confusionMatrix</span>(my_rf)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix (vertical: actual; across: predicted)  for max f1 @ threshold = 0.239020037913721:
          0    1    Error        Rate
0      4556  989 0.178359   =989/5545
1       425 1028 0.292498   =425/1453
Totals 4981 2017 0.202058  =1414/6998</code></pre>
</div>
</div>
</section>
<section id="gradient-boosting-machine" class="level2">
<h2 class="anchored" data-anchor-id="gradient-boosting-machine">Gradient Boosting Machine</h2>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train &amp; Cross-validate a GBM</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>my_gbm <span class="ot">&lt;-</span> <span class="fu">h2o.gbm</span>(<span class="at">x =</span> x_em,</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> y_em,</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">model_id =</span> <span class="st">"GBM"</span>,</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">training_frame =</span> mod_em,</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">distribution =</span> <span class="st">"bernoulli"</span>,</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ntrees =</span> <span class="dv">300</span>,</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">max_depth =</span> <span class="dv">5</span>,</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">min_rows =</span> <span class="dv">50</span>,</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">learn_rate =</span> <span class="fl">0.02</span>,</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nfolds =</span> nfolds,</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fold_assignment =</span> <span class="st">"Stratified"</span>,</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">keep_cross_validation_predictions =</span> <span class="cn">TRUE</span>,</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">seed =</span> <span class="dv">95</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======                                                                |   8%
  |                                                                            
  |==============                                                        |  20%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |====================================                                  |  52%
  |                                                                            
  |==================================================                    |  71%
  |                                                                            
  |========================================================              |  80%
  |                                                                            
  |=================================================================     |  93%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">h2o.confusionMatrix</span>(my_gbm)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix (vertical: actual; across: predicted)  for max f1 @ threshold = 0.324439576278591:
          0    1    Error        Rate
0      5050  495 0.089270   =495/5545
1       587  866 0.403992   =587/1453
Totals 5637 1361 0.154616  =1082/6998</code></pre>
</div>
</div>
</section>
<section id="regresión-logística-1" class="level2">
<h2 class="anchored" data-anchor-id="regresión-logística-1">Regresión Logística</h2>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train &amp; Cross-validate a GLM</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>my_glm <span class="ot">&lt;-</span> <span class="fu">h2o.glm</span>(<span class="at">x =</span> x_em,</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> y_em,</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">model_id =</span> <span class="st">"GLM"</span>,</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">training_frame =</span> mod_em,</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="co"># penaliza inclusión excesiva de variables</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">remove_collinear_columns =</span> <span class="cn">TRUE</span>,</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nfolds =</span> nfolds,</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fold_assignment =</span> <span class="st">"Stratified"</span>,</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">keep_cross_validation_predictions =</span> <span class="cn">TRUE</span>,</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">seed =</span> <span class="dv">95</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">h2o.confusionMatrix</span>(my_glm)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix (vertical: actual; across: predicted)  for max f1 @ threshold = 0.297621966238341:
          0    1    Error        Rate
0      4920  625 0.112714   =625/5545
1       569  884 0.391604   =569/1453
Totals 5489 1509 0.170620  =1194/6998</code></pre>
</div>
</div>
</section>
<section id="ensamble-rf-gbm" class="level2">
<h2 class="anchored" data-anchor-id="ensamble-rf-gbm">Ensamble RF + GBM</h2>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train ensamble</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>e1m <span class="ot">&lt;-</span> <span class="fu">h2o.stackedEnsemble</span>(<span class="at">x =</span> x_em,</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">y =</span> y_em,</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">training_frame =</span> mod_em,</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">model_id =</span> <span class="st">"Ensamble_1m"</span>,</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>                           <span class="at">metalearner_algorithm =</span> <span class="st">"deeplearning"</span>,</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>                           <span class="at">base_models =</span> <span class="fu">list</span>(my_rf, my_gbm))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
</div>
</section>
<section id="ensamble-rf-rl" class="level2">
<h2 class="anchored" data-anchor-id="ensamble-rf-rl">Ensamble RF + RL</h2>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>e2m <span class="ot">&lt;-</span> <span class="fu">h2o.stackedEnsemble</span>(<span class="at">x =</span> x_em,</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">y =</span> y_em,</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">training_frame =</span> mod_em,</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">model_id =</span> <span class="st">"Ensamble_2m"</span>,</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">metalearner_algorithm =</span> <span class="st">"deeplearning"</span>,</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">base_models =</span> <span class="fu">list</span>(my_rf, my_glm))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
</div>
<p>Ensamble RF + RL + GBM</p>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>e3m <span class="ot">&lt;-</span> <span class="fu">h2o.stackedEnsemble</span>(<span class="at">x =</span> x_em,</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">y =</span> y_em,</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">training_frame =</span> mod_em,</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">model_id =</span> <span class="st">"Ensamble3m"</span>,</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">metalearner_algorithm =</span> <span class="st">"deeplearning"</span>,</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">base_models =</span> <span class="fu">list</span>(my_rf, my_gbm, my_glm))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
</div>
</section>
<section id="predicciones" class="level2">
<h2 class="anchored" data-anchor-id="predicciones">Predicciones</h2>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Realizamos los predicciones sobre la muestra de modelamiento / validación</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>mod_em <span class="ot">&lt;-</span> <span class="fu">as.h2o</span>(<span class="at">x =</span> <span class="fu">setDT</span>(mod)[, vars, <span class="at">with =</span> <span class="cn">FALSE</span>])</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>val_em <span class="ot">&lt;-</span> <span class="fu">as.h2o</span>(<span class="at">x =</span> <span class="fu">setDT</span>(val)[, vars, <span class="at">with =</span> <span class="cn">FALSE</span>])</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>mod_em[,y_em] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(mod_em[, y_em])</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>val_em[,y_em] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(val_em[, y_em])</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>res_f <span class="ot">&lt;-</span> <span class="cf">function</span>(valida, resul){</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Exited =</span> valida<span class="sc">$</span>Exited,</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Exited_p =</span> <span class="fu">as.data.frame</span>(resul)[,<span class="dv">3</span>],<span class="dv">0</span>)</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>} </span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>roc_graf <span class="ot">&lt;-</span> <span class="cf">function</span>(res_mod, res_val, <span class="at">name=</span><span class="st">""</span>){</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>objroc1 <span class="ot">&lt;-</span> <span class="fu">roc</span>(res_mod<span class="sc">$</span>Exited, res_mod<span class="sc">$</span>Exited_p, <span class="at">auc=</span>T, <span class="at">ci=</span>T)</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(objroc1, <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">xlab=</span><span class="st">"1 - Especificidad"</span>, <span class="at">ylab=</span><span class="st">"Sensibilidad"</span>, <span class="at">main=</span><span class="fu">paste</span>(<span class="st">"Comparación curvas ROC"</span>,name), <span class="at">legacy.axes =</span> <span class="cn">TRUE</span>)</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>objroc2 <span class="ot">&lt;-</span> <span class="fu">roc</span>(res_val<span class="sc">$</span>Exited, res_val<span class="sc">$</span>Exited_p, <span class="at">auc=</span>T, <span class="at">ci=</span>T)</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(objroc2, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomright"</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"Modelamiento"</span>,<span class="fu">round</span>(objroc1<span class="sc">$</span>auc, <span class="dv">3</span>)), <span class="fu">paste</span>(<span class="st">"Validación"</span>, <span class="fu">round</span>(objroc2<span class="sc">$</span>auc, <span class="dv">3</span>))), <span class="at">col=</span><span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>), <span class="at">lwd=</span><span class="fl">0.5</span>, <span class="at">title =</span> <span class="st">"AUC-ROC"</span>)</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="curva-roc-rf" class="level2">
<h2 class="anchored" data-anchor-id="curva-roc-rf">Curva ROC RF</h2>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Random Forest</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>mod_rf <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(mod, <span class="fu">h2o.predict</span>(my_rf, <span class="at">newdata =</span> mod_em)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>val_rf <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(val, <span class="fu">h2o.predict</span>(my_rf, <span class="at">newdata =</span> val_em)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">roc_graf</span>(mod_rf,val_rf, <span class="st">"RF"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="curva-roc-rl" class="level2">
<h2 class="anchored" data-anchor-id="curva-roc-rl">Curva ROC RL</h2>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Regresión Logística</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>mod_glm <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(mod, <span class="fu">h2o.predict</span>(my_glm, <span class="at">newdata =</span> mod_em)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>val_glm <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(val, <span class="fu">h2o.predict</span>(my_glm, <span class="at">newdata =</span> val_em)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">roc_graf</span>(mod_glm,val_glm, <span class="st">"Regresión Logística"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="curva-roc-gbm" class="level2">
<h2 class="anchored" data-anchor-id="curva-roc-gbm">Curva ROC GBM</h2>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Gradient Boosting </span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>mod_gbm <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(mod, <span class="fu">h2o.predict</span>(my_gbm, <span class="at">newdata =</span> mod_em)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>val_gbm <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(val, <span class="fu">h2o.predict</span>(my_gbm, <span class="at">newdata =</span> val_em)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">roc_graf</span>(mod_gbm,val_gbm, <span class="st">"Gradient Boosting"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="curva-roc-rf-gbm" class="level2">
<h2 class="anchored" data-anchor-id="curva-roc-rf-gbm">Curva ROC RF + GBM</h2>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensamble RF + GBM</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>mod_e1m <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(mod, <span class="fu">h2o.predict</span>(e1m, <span class="at">newdata =</span> mod_em)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>val_e1m <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(val, <span class="fu">h2o.predict</span>(e1m, <span class="at">newdata =</span> val_em)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">roc_graf</span>(mod_e1m,val_e1m, <span class="st">"Ensamble RF + GBM"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="curva-roc-rf-rl" class="level2">
<h2 class="anchored" data-anchor-id="curva-roc-rf-rl">Curva ROC RF + RL</h2>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensamble GLM +RF</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>mod_e2m <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(mod, <span class="fu">h2o.predict</span>(e2m, <span class="at">newdata =</span> mod_em)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>val_e2m <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(val, <span class="fu">h2o.predict</span>(e2m, <span class="at">newdata =</span> val_em)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">roc_graf</span>(mod_e2m,val_e2m, <span class="st">"Ensamble RF + GLM(RL)"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="curva-roc-rl-rf-gbm" class="level2">
<h2 class="anchored" data-anchor-id="curva-roc-rl-rf-gbm">Curva ROC RL + RF + GBM</h2>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensamble GLM + RF + GBM</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>mod_e3m <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(mod, <span class="fu">h2o.predict</span>(e3m, <span class="at">newdata =</span> mod_em)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>val_e3m <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(val, <span class="fu">h2o.predict</span>(e3m, <span class="at">newdata =</span> val_em)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">roc_graf</span>(mod_e3m,val_e3m, <span class="st">"Ensamble RF + GBM + GLM(RL)"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="conclusiones" class="level1">
<h1>Conclusiones</h1>
<ul>
<li>Notemos que en la mayoria de casos se ha alcanzado AUC-ROC <span class="math inline">\(\geq 0.80\)</span> sin embargo el mejor modelo es el Ensamble de Random Forest + Gradient Boosting Machine + GLM( Regresión Logística) con una AUC-ROC validación de <span class="math inline">\(0.85\)</span>. Sin embargo el modelo también se ve sometido a requerimientos y recursos propios del negocio por lo que puede quedarse fuera y se opte por un modelo menos costoso en cuestión de tiempo y recursos.</li>
</ul>
</section>
<section id="recomendaciones" class="level1">
<h1>Recomendaciones</h1>
<ul>
<li>En esta ocasión no hemos recurrido a una automatización completa del proceso de creación del modelo por lo que se podría explorar la creación de ensambles partiendo de las variables binneadas por optimal binning.</li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiado");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiado");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/joel-x\.github\.io\/jb_blog\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Ejecutar el código</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb111" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> Churn Rate (Tasa de Abandono)</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> Joel Burbano</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 08-27-2024</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> [R, Machine Learning]</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>En este proyecto vamos a desarrollar un  modelo predictivo para identificar clientes con alto riesgo de churn</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>(abandono) en una institución bancaria, utilizando técnicas de Machine Learning </span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a><span class="fu"># Importación de Datos</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Importamos las librerias</span></span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"D:/Joel/Blog/recursos/funciones_aux.R"</span>)</span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"Churn_Modelling.csv"</span>)</span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df,<span class="dv">5</span>)</span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-24"><a href="#cb111-24" aria-hidden="true" tabindex="-1"></a>breve revisión a la variable dependiente</span>
<span id="cb111-25"><a href="#cb111-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-28"><a href="#cb111-28" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-29"><a href="#cb111-29" aria-hidden="true" tabindex="-1"></a>df[, .N, by <span class="ot">=</span> Exited]</span>
<span id="cb111-30"><a href="#cb111-30" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-31"><a href="#cb111-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-32"><a href="#cb111-32" aria-hidden="true" tabindex="-1"></a>Notamos que la data esta desbalanceada con el grupo mayoritario 1 que son las personas que abandonan</span>
<span id="cb111-33"><a href="#cb111-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-34"><a href="#cb111-34" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>0 No abandona</span>
<span id="cb111-35"><a href="#cb111-35" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>1 Abandona</span>
<span id="cb111-36"><a href="#cb111-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-37"><a href="#cb111-37" aria-hidden="true" tabindex="-1"></a><span class="fu"># Particionamos la data en conjuntos Train / Test</span></span>
<span id="cb111-38"><a href="#cb111-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-41"><a href="#cb111-41" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-42"><a href="#cb111-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Base de modelamiento / validacion</span></span>
<span id="cb111-43"><a href="#cb111-43" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">95</span>)</span>
<span id="cb111-44"><a href="#cb111-44" aria-hidden="true" tabindex="-1"></a>marca <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df), <span class="at">size =</span> <span class="fu">floor</span>(<span class="fl">0.7</span> <span class="sc">*</span> <span class="fu">nrow</span>(df)), <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb111-45"><a href="#cb111-45" aria-hidden="true" tabindex="-1"></a>df[, ModVal <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df)]</span>
<span id="cb111-46"><a href="#cb111-46" aria-hidden="true" tabindex="-1"></a>df[, ModVal <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(ModVal <span class="sc">%in%</span> marca, <span class="dv">0</span>, <span class="dv">1</span>)]</span>
<span id="cb111-47"><a href="#cb111-47" aria-hidden="true" tabindex="-1"></a>df[, .N, by <span class="ot">=</span> ModVal]</span>
<span id="cb111-48"><a href="#cb111-48" aria-hidden="true" tabindex="-1"></a>df[, <span class="fu">table</span>(Exited, ModVal, <span class="at">useNA =</span> <span class="st">"always"</span>)]</span>
<span id="cb111-49"><a href="#cb111-49" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-50"><a href="#cb111-50" aria-hidden="true" tabindex="-1"></a><span class="fu"># Análisis Exploratorio </span></span>
<span id="cb111-51"><a href="#cb111-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-52"><a href="#cb111-52" aria-hidden="true" tabindex="-1"></a><span class="fu">## Tipo de datos</span></span>
<span id="cb111-53"><a href="#cb111-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-56"><a href="#cb111-56" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-57"><a href="#cb111-57" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(df)</span>
<span id="cb111-58"><a href="#cb111-58" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-59"><a href="#cb111-59" aria-hidden="true" tabindex="-1"></a>creamos una lista de variables para mejor manipulación</span>
<span id="cb111-62"><a href="#cb111-62" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-63"><a href="#cb111-63" aria-hidden="true" tabindex="-1"></a>index <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"RowNumber"</span>, <span class="st">"CustomerId"</span>,<span class="st">"Surname"</span>)</span>
<span id="cb111-64"><a href="#cb111-64" aria-hidden="true" tabindex="-1"></a>var_num <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"CreditScore"</span>, <span class="st">"Age"</span>, <span class="st">"Tenure"</span>, <span class="st">"Balance"</span>,<span class="st">"EstimatedSalary"</span>)</span>
<span id="cb111-65"><a href="#cb111-65" aria-hidden="true" tabindex="-1"></a>var_cat <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(df),<span class="fu">c</span>(index,var_num,<span class="st">"Exited"</span>))</span>
<span id="cb111-66"><a href="#cb111-66" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-67"><a href="#cb111-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-68"><a href="#cb111-68" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cambio de nombres de las columnas</span></span>
<span id="cb111-69"><a href="#cb111-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-70"><a href="#cb111-70" aria-hidden="true" tabindex="-1"></a>En esta ocasión no vamos a cambiar ningun nombre</span>
<span id="cb111-71"><a href="#cb111-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-72"><a href="#cb111-72" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exploración de datos</span></span>
<span id="cb111-73"><a href="#cb111-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-74"><a href="#cb111-74" aria-hidden="true" tabindex="-1"></a>Primero visualicemos un breve resumen de las variables</span>
<span id="cb111-75"><a href="#cb111-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-78"><a href="#cb111-78" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-79"><a href="#cb111-79" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(df)</span>
<span id="cb111-80"><a href="#cb111-80" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-81"><a href="#cb111-81" aria-hidden="true" tabindex="-1"></a>Notamos que existen valores perdidos o NA's, los mismos que serán tratados mas adelante</span>
<span id="cb111-82"><a href="#cb111-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-83"><a href="#cb111-83" aria-hidden="true" tabindex="-1"></a><span class="fu">## Evaluación de valores nulos</span></span>
<span id="cb111-86"><a href="#cb111-86" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-87"><a href="#cb111-87" aria-hidden="true" tabindex="-1"></a><span class="co"># tratamiento NA's </span></span>
<span id="cb111-88"><a href="#cb111-88" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df[<span class="sc">!</span>(<span class="fu">is.na</span>(HasCrCard) <span class="sc">==</span> <span class="cn">TRUE</span>),]</span>
<span id="cb111-89"><a href="#cb111-89" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df[<span class="sc">!</span>(<span class="fu">is.na</span>(IsActiveMember) <span class="sc">==</span> <span class="cn">TRUE</span>),]</span>
<span id="cb111-90"><a href="#cb111-90" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df[<span class="sc">!</span>(<span class="fu">is.na</span>(Age) <span class="sc">==</span> <span class="cn">TRUE</span>),]</span>
<span id="cb111-91"><a href="#cb111-91" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(df))</span>
<span id="cb111-92"><a href="#cb111-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-93"><a href="#cb111-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-94"><a href="#cb111-94" aria-hidden="true" tabindex="-1"></a><span class="fu">## Valores duplicados</span></span>
<span id="cb111-95"><a href="#cb111-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-98"><a href="#cb111-98" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-99"><a href="#cb111-99" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">unique</span>(df)</span>
<span id="cb111-100"><a href="#cb111-100" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-101"><a href="#cb111-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-102"><a href="#cb111-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-103"><a href="#cb111-103" aria-hidden="true" tabindex="-1"></a><span class="fu">## Proporción del variable dependiente</span></span>
<span id="cb111-104"><a href="#cb111-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-107"><a href="#cb111-107" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-108"><a href="#cb111-108" aria-hidden="true" tabindex="-1"></a>df[, <span class="fu">round</span>(.N <span class="sc">/</span> <span class="fu">nrow</span>(df),<span class="dv">3</span>), by <span class="ot">=</span> Exited]</span>
<span id="cb111-109"><a href="#cb111-109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-110"><a href="#cb111-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-111"><a href="#cb111-111" aria-hidden="true" tabindex="-1"></a><span class="fu"># Seleccion de Variables (KS / VI)</span></span>
<span id="cb111-112"><a href="#cb111-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-115"><a href="#cb111-115" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-116"><a href="#cb111-116" aria-hidden="true" tabindex="-1"></a><span class="co"># KS VI</span></span>
<span id="cb111-117"><a href="#cb111-117" aria-hidden="true" tabindex="-1"></a><span class="co"># Sujetos buenos y malos para calculo de KS</span></span>
<span id="cb111-118"><a href="#cb111-118" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> df[ModVal <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> Exited <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)]</span>
<span id="cb111-119"><a href="#cb111-119" aria-hidden="true" tabindex="-1"></a>val <span class="ot">&lt;-</span> df[ModVal <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb111-120"><a href="#cb111-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-121"><a href="#cb111-121" aria-hidden="true" tabindex="-1"></a><span class="co"># identificación de variables con alto porcentaje de NA's</span></span>
<span id="cb111-122"><a href="#cb111-122" aria-hidden="true" tabindex="-1"></a>porc <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">sapply</span>(mod, porcNA), <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb111-123"><a href="#cb111-123" aria-hidden="true" tabindex="-1"></a>PorcentajeNA <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">names</span>(porc), <span class="fu">as.numeric</span>(porc))</span>
<span id="cb111-124"><a href="#cb111-124" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(PorcentajeNA) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Var"</span>, <span class="st">"Por"</span>)</span>
<span id="cb111-125"><a href="#cb111-125" aria-hidden="true" tabindex="-1"></a>dvars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">colnames</span>(mod), <span class="fu">names</span>(porc)[porc <span class="sc">&gt;</span> <span class="fl">0.3</span>])</span>
<span id="cb111-126"><a href="#cb111-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-127"><a href="#cb111-127" aria-hidden="true" tabindex="-1"></a><span class="co"># tratamiento NA's </span></span>
<span id="cb111-128"><a href="#cb111-128" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df[<span class="sc">!</span>(<span class="fu">is.na</span>(HasCrCard) <span class="sc">==</span> <span class="cn">TRUE</span>),]</span>
<span id="cb111-129"><a href="#cb111-129" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df[<span class="sc">!</span>(<span class="fu">is.na</span>(IsActiveMember) <span class="sc">==</span> <span class="cn">TRUE</span>),]</span>
<span id="cb111-130"><a href="#cb111-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-131"><a href="#cb111-131" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> df[ModVal <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> Exited <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)]</span>
<span id="cb111-132"><a href="#cb111-132" aria-hidden="true" tabindex="-1"></a>val <span class="ot">&lt;-</span> df[ModVal <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb111-133"><a href="#cb111-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-134"><a href="#cb111-134" aria-hidden="true" tabindex="-1"></a><span class="co"># Identificación de variables constantes</span></span>
<span id="cb111-135"><a href="#cb111-135" aria-hidden="true" tabindex="-1"></a>dvars <span class="ot">&lt;-</span> dvars[<span class="sc">!</span><span class="fu">unname</span>(<span class="fu">unlist</span>(<span class="fu">sapply</span>(mod[,dvars, <span class="at">with =</span> <span class="cn">FALSE</span>], constante)))]</span>
<span id="cb111-136"><a href="#cb111-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-137"><a href="#cb111-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-138"><a href="#cb111-138" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejecución de KS &amp; VI</span></span>
<span id="cb111-139"><a href="#cb111-139" aria-hidden="true" tabindex="-1"></a>vnum <span class="ot">&lt;-</span> <span class="fu">colnames</span>(mod)[<span class="fu">unname</span>(<span class="fu">sapply</span>(mod, class)) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"numeric"</span>, <span class="st">"integer"</span>) ]</span>
<span id="cb111-140"><a href="#cb111-140" aria-hidden="true" tabindex="-1"></a>vcat <span class="ot">&lt;-</span> <span class="fu">colnames</span>(mod)[<span class="fu">unname</span>(<span class="fu">sapply</span>(mod, class)) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"character"</span>, <span class="st">"logical"</span>)]</span>
<span id="cb111-141"><a href="#cb111-141" aria-hidden="true" tabindex="-1"></a>dnum <span class="ot">&lt;-</span> mod[, vnum, with <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb111-142"><a href="#cb111-142" aria-hidden="true" tabindex="-1"></a>dcat <span class="ot">&lt;-</span> mod[, vcat, with <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb111-143"><a href="#cb111-143" aria-hidden="true" tabindex="-1"></a>VI <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">sapply</span>(dcat, TestVI, <span class="at">y =</span> mod<span class="sc">$</span>Exited), <span class="at">decreasing =</span> T)</span>
<span id="cb111-144"><a href="#cb111-144" aria-hidden="true" tabindex="-1"></a>dVI <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">names</span>(VI), VI)</span>
<span id="cb111-145"><a href="#cb111-145" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(dVI) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Variable"</span>, <span class="st">"VI"</span>); <span class="fu">rownames</span>(dVI) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb111-146"><a href="#cb111-146" aria-hidden="true" tabindex="-1"></a>dVI</span>
<span id="cb111-147"><a href="#cb111-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-148"><a href="#cb111-148" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-149"><a href="#cb111-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-152"><a href="#cb111-152" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-153"><a href="#cb111-153" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculo de KS sobre variables numericas</span></span>
<span id="cb111-154"><a href="#cb111-154" aria-hidden="true" tabindex="-1"></a>KS <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">seq_along</span>(dnum), <span class="cf">function</span>(i){<span class="fu">TestKS</span>(dnum[[i]], mod<span class="sc">$</span>Exited)})</span>
<span id="cb111-155"><a href="#cb111-155" aria-hidden="true" tabindex="-1"></a>dKS <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">colnames</span>(dnum), KS); dKS <span class="ot">&lt;-</span> dKS[<span class="fu">order</span>(dKS<span class="sc">$</span>KS, <span class="at">decreasing =</span> <span class="cn">TRUE</span>),]</span>
<span id="cb111-156"><a href="#cb111-156" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(dKS) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Variable"</span>, <span class="st">"KS"</span>); <span class="fu">rownames</span>(dKS) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb111-157"><a href="#cb111-157" aria-hidden="true" tabindex="-1"></a>dKS</span>
<span id="cb111-158"><a href="#cb111-158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-159"><a href="#cb111-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-160"><a href="#cb111-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-161"><a href="#cb111-161" aria-hidden="true" tabindex="-1"></a>Seleccionamos las variables con valores altos de KS / VI</span>
<span id="cb111-162"><a href="#cb111-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-163"><a href="#cb111-163" aria-hidden="true" tabindex="-1"></a><span class="fu"># Creación de Features para el modelo</span></span>
<span id="cb111-164"><a href="#cb111-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-165"><a href="#cb111-165" aria-hidden="true" tabindex="-1"></a><span class="fu">## Creación de features personalizada </span></span>
<span id="cb111-168"><a href="#cb111-168" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-169"><a href="#cb111-169" aria-hidden="true" tabindex="-1"></a><span class="co"># Construcción de variables y discretización </span></span>
<span id="cb111-170"><a href="#cb111-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-171"><a href="#cb111-171" aria-hidden="true" tabindex="-1"></a>df[,prbm_NumOfProducts <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(NumOfProducts <span class="sc">&lt;</span> <span class="fl">1.5</span>, <span class="fl">0.2776061</span>,</span>
<span id="cb111-172"><a href="#cb111-172" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">ifelse</span>(NumOfProducts <span class="sc">&lt;</span> <span class="fl">2.5</span>, <span class="fl">0.0800000</span>, <span class="fl">0.8744770</span>))]</span>
<span id="cb111-173"><a href="#cb111-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-174"><a href="#cb111-174" aria-hidden="true" tabindex="-1"></a>df[,prbm_Age <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(Age <span class="sc">&lt;</span> <span class="fl">42.5</span>, <span class="fl">0.1208350</span>,</span>
<span id="cb111-175"><a href="#cb111-175" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">ifelse</span>(Age <span class="sc">&lt;</span> <span class="fl">46.5</span>, <span class="fl">0.3450704</span>,</span>
<span id="cb111-176"><a href="#cb111-176" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">ifelse</span>(Age <span class="sc">&lt;</span> <span class="fl">57.5</span>, <span class="fl">0.5261364</span>, <span class="fl">0.3356808</span>)))]</span>
<span id="cb111-177"><a href="#cb111-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-178"><a href="#cb111-178" aria-hidden="true" tabindex="-1"></a>df[, prbm_IsActiveMember <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(IsActiveMember <span class="sc">&lt;</span> <span class="fl">0.5</span>, <span class="fl">0.1451298</span>,<span class="fl">0.2732064</span>)]</span>
<span id="cb111-179"><a href="#cb111-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-180"><a href="#cb111-180" aria-hidden="true" tabindex="-1"></a>df[, prbm_Geography <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(Geography <span class="sc">==</span> <span class="st">"France"</span>, <span class="fl">0.1667147</span>,</span>
<span id="cb111-181"><a href="#cb111-181" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">ifelse</span>(Geography <span class="sc">==</span> <span class="st">"Spain"</span>,<span class="fl">0.1624077</span>, <span class="fl">0.3327684</span>))]</span>
<span id="cb111-182"><a href="#cb111-182" aria-hidden="true" tabindex="-1"></a>df[, prbm_Balance <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(Balance <span class="sc">&lt;</span> <span class="fl">1884.5</span>, <span class="fl">0.1368209</span>, <span class="fl">0.2466209</span>)]</span>
<span id="cb111-183"><a href="#cb111-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-184"><a href="#cb111-184" aria-hidden="true" tabindex="-1"></a>df[, prbm_Gender <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(Gender <span class="sc">==</span> <span class="st">"Male"</span>, <span class="fl">0.1714436</span> , <span class="fl">0.2507042</span>)]</span>
<span id="cb111-185"><a href="#cb111-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-186"><a href="#cb111-186" aria-hidden="true" tabindex="-1"></a>df[, prbm_CreditScore <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(CreditScore <span class="sc">&lt;=</span> <span class="fl">407.5</span>, <span class="fl">0.94444444</span> ,<span class="fl">0.20573066</span>)]</span>
<span id="cb111-187"><a href="#cb111-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-188"><a href="#cb111-188" aria-hidden="true" tabindex="-1"></a>df[, prbm_EstimatedSalary <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(EstimatedSalary <span class="sc">&lt;=</span> <span class="dv">25000</span>, <span class="fl">0.2031063</span>,</span>
<span id="cb111-189"><a href="#cb111-189" aria-hidden="true" tabindex="-1"></a>                                    <span class="fu">ifelse</span>(EstimatedSalary <span class="sc">&lt;=</span> <span class="dv">35000</span>, <span class="fl">0.2156863</span>,</span>
<span id="cb111-190"><a href="#cb111-190" aria-hidden="true" tabindex="-1"></a>                                           <span class="fu">ifelse</span>(EstimatedSalary <span class="sc">&lt;=</span> <span class="dv">60000</span>, <span class="fl">0.1944134</span>,</span>
<span id="cb111-191"><a href="#cb111-191" aria-hidden="true" tabindex="-1"></a>                                                  <span class="fu">ifelse</span>(EstimatedSalary <span class="sc">&lt;=</span> <span class="dv">75000</span>, <span class="fl">0.2189239</span>,</span>
<span id="cb111-192"><a href="#cb111-192" aria-hidden="true" tabindex="-1"></a>                                                         <span class="fu">ifelse</span>(EstimatedSalary <span class="sc">&lt;=</span> <span class="dv">85000</span>, <span class="fl">0.1789474</span>,</span>
<span id="cb111-193"><a href="#cb111-193" aria-hidden="true" tabindex="-1"></a>                                                                <span class="fu">ifelse</span>(EstimatedSalary <span class="sc">&lt;=</span> <span class="dv">155000</span>, <span class="fl">0.1990913</span>,</span>
<span id="cb111-194"><a href="#cb111-194" aria-hidden="true" tabindex="-1"></a>                                                                       <span class="fu">ifelse</span>(EstimatedSalary <span class="sc">&lt;=</span> <span class="dv">185000</span>, <span class="fl">0.2301815</span>, <span class="fl">0.1965649</span>))))))  )]</span>
<span id="cb111-195"><a href="#cb111-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-196"><a href="#cb111-196" aria-hidden="true" tabindex="-1"></a><span class="co"># Generación de muestras para el performance del modelo</span></span>
<span id="cb111-197"><a href="#cb111-197" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> df[ModVal <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> Exited <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)]</span>
<span id="cb111-198"><a href="#cb111-198" aria-hidden="true" tabindex="-1"></a>val <span class="ot">&lt;-</span> df[ModVal <span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb111-199"><a href="#cb111-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-200"><a href="#cb111-200" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-201"><a href="#cb111-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-202"><a href="#cb111-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-203"><a href="#cb111-203" aria-hidden="true" tabindex="-1"></a><span class="fu">### Regresión Logística</span></span>
<span id="cb111-204"><a href="#cb111-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-207"><a href="#cb111-207" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-208"><a href="#cb111-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Regresión logistica</span></span>
<span id="cb111-209"><a href="#cb111-209" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> <span class="st">"Exited ~</span></span>
<span id="cb111-210"><a href="#cb111-210" aria-hidden="true" tabindex="-1"></a><span class="st">  prbm_NumOfProducts +</span></span>
<span id="cb111-211"><a href="#cb111-211" aria-hidden="true" tabindex="-1"></a><span class="st">  prbm_Age +</span></span>
<span id="cb111-212"><a href="#cb111-212" aria-hidden="true" tabindex="-1"></a><span class="st">  prbm_IsActiveMember +</span></span>
<span id="cb111-213"><a href="#cb111-213" aria-hidden="true" tabindex="-1"></a><span class="st">  prbm_Geography + </span></span>
<span id="cb111-214"><a href="#cb111-214" aria-hidden="true" tabindex="-1"></a><span class="st">  prbm_Gender +</span></span>
<span id="cb111-215"><a href="#cb111-215" aria-hidden="true" tabindex="-1"></a><span class="st">  prbm_EstimatedSalary</span></span>
<span id="cb111-216"><a href="#cb111-216" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb111-217"><a href="#cb111-217" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="at">formula =</span> <span class="fu">as.formula</span>(formula), <span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">"logit"</span>), <span class="at">data =</span> mod)</span>
<span id="cb111-218"><a href="#cb111-218" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelo)</span>
<span id="cb111-219"><a href="#cb111-219" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-222"><a href="#cb111-222" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-223"><a href="#cb111-223" aria-hidden="true" tabindex="-1"></a>nom_vars <span class="ot">&lt;-</span> <span class="fu">all.vars</span>(<span class="fu">terms</span>(modelo))[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb111-224"><a href="#cb111-224" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">cor</span>(<span class="fu">setDT</span>(mod)[, ..nom_vars])</span>
<span id="cb111-225"><a href="#cb111-225" aria-hidden="true" tabindex="-1"></a>res</span>
<span id="cb111-226"><a href="#cb111-226" aria-hidden="true" tabindex="-1"></a><span class="fu">eigen</span>(res)</span>
<span id="cb111-227"><a href="#cb111-227" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>( <span class="fu">head</span>(<span class="fu">eigen</span>(res)<span class="sc">$</span>values,<span class="dv">1</span>) <span class="sc">/</span> <span class="fu">tail</span>(<span class="fu">eigen</span>(res)<span class="sc">$</span>values,<span class="dv">1</span>)) <span class="co"># calculo IC &gt; 5 indicios multicolinealidad</span></span>
<span id="cb111-228"><a href="#cb111-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-229"><a href="#cb111-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-230"><a href="#cb111-230" aria-hidden="true" tabindex="-1"></a>df[, Y<span class="sc">:</span><span class="er">=</span> modelo<span class="sc">$</span>coefficients[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">Reduce</span>(<span class="st">`</span><span class="at">+</span><span class="st">`</span>, <span class="fu">Map</span>(<span class="cf">function</span>(var, coef) <span class="fu">get</span>(var) <span class="sc">*</span> coef, <span class="fu">names</span>(modelo<span class="sc">$</span>coefficients[<span class="sc">-</span><span class="dv">1</span>]), modelo<span class="sc">$</span>coefficients[<span class="sc">-</span><span class="dv">1</span>]))]</span>
<span id="cb111-231"><a href="#cb111-231" aria-hidden="true" tabindex="-1"></a>df[, RL <span class="sc">:</span><span class="er">=</span> (<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(Y)))]</span>
<span id="cb111-232"><a href="#cb111-232" aria-hidden="true" tabindex="-1"></a><span class="co">#quantile(df$RL, probs = seq(0 , 1, by = 0.01), na.rm = TRUE)</span></span>
<span id="cb111-233"><a href="#cb111-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-234"><a href="#cb111-234" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> df[ModVal <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> Exited <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)]</span>
<span id="cb111-235"><a href="#cb111-235" aria-hidden="true" tabindex="-1"></a>val <span class="ot">&lt;-</span> df[ModVal <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb111-236"><a href="#cb111-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-237"><a href="#cb111-237" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimación  Probabilidades</span></span>
<span id="cb111-238"><a href="#cb111-238" aria-hidden="true" tabindex="-1"></a>res_mod <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">Var =</span> mod<span class="sc">$</span>Exited, <span class="at">RL =</span> mod<span class="sc">$</span>RL)</span>
<span id="cb111-239"><a href="#cb111-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-240"><a href="#cb111-240" aria-hidden="true" tabindex="-1"></a>res_val <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">Var =</span> val<span class="sc">$</span>Exited, <span class="at">RL =</span> val<span class="sc">$</span>RL)</span>
<span id="cb111-241"><a href="#cb111-241" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-242"><a href="#cb111-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-243"><a href="#cb111-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-246"><a href="#cb111-246" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-247"><a href="#cb111-247" aria-hidden="true" tabindex="-1"></a><span class="co"># Gráficas ROC</span></span>
<span id="cb111-248"><a href="#cb111-248" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC)</span>
<span id="cb111-249"><a href="#cb111-249" aria-hidden="true" tabindex="-1"></a>objroc1 <span class="ot">&lt;-</span> <span class="fu">roc</span>(res_mod<span class="sc">$</span>Var, res_mod<span class="sc">$</span>RL, <span class="at">auc=</span>T, <span class="at">ci=</span>T)</span>
<span id="cb111-250"><a href="#cb111-250" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(objroc1, <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">xlab=</span><span class="st">"1 - Especificidad"</span>, <span class="at">ylab=</span><span class="st">"Sensibilidad"</span>, <span class="at">main=</span><span class="st">"Comparación curvas ROC"</span>, <span class="at">legacy.axes =</span> <span class="cn">TRUE</span>)</span>
<span id="cb111-251"><a href="#cb111-251" aria-hidden="true" tabindex="-1"></a>objroc2 <span class="ot">&lt;-</span> <span class="fu">roc</span>(res_val<span class="sc">$</span>Var, res_val<span class="sc">$</span>RL, <span class="at">auc=</span>T, <span class="at">ci=</span>T)</span>
<span id="cb111-252"><a href="#cb111-252" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(objroc2, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb111-253"><a href="#cb111-253" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomright"</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"Modelamiento"</span>,<span class="fu">round</span>(objroc1<span class="sc">$</span>auc, <span class="dv">3</span>)), <span class="fu">paste</span>(<span class="st">"Validación"</span>, <span class="fu">round</span>(objroc2<span class="sc">$</span>auc, <span class="dv">3</span>))), <span class="at">col=</span><span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>), <span class="at">lwd=</span><span class="fl">0.5</span>, <span class="at">title =</span> <span class="st">"AUC-ROC"</span>)</span>
<span id="cb111-254"><a href="#cb111-254" aria-hidden="true" tabindex="-1"></a><span class="co">#legend("topright", legend = c(round(objroc1$auc, 3), round(objroc2$auc, 3)), col = c("blue", "red"), lwd = 0.2 , title = "AUC-ROC")</span></span>
<span id="cb111-255"><a href="#cb111-255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-256"><a href="#cb111-256" aria-hidden="true" tabindex="-1"></a>Con estas features se ha alcanzado un AUC-ROC con la data de validación de <span class="in">`r round(objroc2$auc, 3)`</span></span>
<span id="cb111-257"><a href="#cb111-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-258"><a href="#cb111-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-259"><a href="#cb111-259" aria-hidden="true" tabindex="-1"></a><span class="fu">## Optimal binning</span></span>
<span id="cb111-260"><a href="#cb111-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-261"><a href="#cb111-261" aria-hidden="true" tabindex="-1"></a>Creando los features y bins con la libreria <span class="in">`scorecard`</span></span>
<span id="cb111-262"><a href="#cb111-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-265"><a href="#cb111-265" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-266"><a href="#cb111-266" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("scorecard")</span></span>
<span id="cb111-267"><a href="#cb111-267" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scorecard)</span>
<span id="cb111-268"><a href="#cb111-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-269"><a href="#cb111-269" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"NumOfProducts"</span>, <span class="st">"Age"</span>, <span class="st">"IsActiveMember"</span>, <span class="st">"Geography"</span>, <span class="st">"Gender"</span>, <span class="st">"EstimatedSalary"</span>)</span>
<span id="cb111-270"><a href="#cb111-270" aria-hidden="true" tabindex="-1"></a>bins <span class="ot">&lt;-</span> <span class="fu">woebin</span>(df, <span class="at">y =</span> <span class="st">"Exited"</span>, <span class="at">x =</span> vars)</span>
<span id="cb111-271"><a href="#cb111-271" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(bins)</span>
<span id="cb111-272"><a href="#cb111-272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-273"><a href="#cb111-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-276"><a href="#cb111-276" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-277"><a href="#cb111-277" aria-hidden="true" tabindex="-1"></a>df_bineed <span class="ot">&lt;-</span> <span class="fu">woebin_ply</span>(df,<span class="at">bins =</span> bins)</span>
<span id="cb111-278"><a href="#cb111-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-279"><a href="#cb111-279" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_bineed, <span class="dv">5</span>)</span>
<span id="cb111-280"><a href="#cb111-280" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-283"><a href="#cb111-283" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-284"><a href="#cb111-284" aria-hidden="true" tabindex="-1"></a><span class="co"># Generación de muestras para el performance del modelo</span></span>
<span id="cb111-285"><a href="#cb111-285" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> df_bineed[ModVal <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> Exited <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)]</span>
<span id="cb111-286"><a href="#cb111-286" aria-hidden="true" tabindex="-1"></a>val <span class="ot">&lt;-</span> df_bineed[ModVal <span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb111-287"><a href="#cb111-287" aria-hidden="true" tabindex="-1"></a><span class="co"># Regresión logistica</span></span>
<span id="cb111-288"><a href="#cb111-288" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> <span class="st">"Exited ~</span></span>
<span id="cb111-289"><a href="#cb111-289" aria-hidden="true" tabindex="-1"></a><span class="st">  NumOfProducts_woe +</span></span>
<span id="cb111-290"><a href="#cb111-290" aria-hidden="true" tabindex="-1"></a><span class="st">  Age_woe +</span></span>
<span id="cb111-291"><a href="#cb111-291" aria-hidden="true" tabindex="-1"></a><span class="st">  IsActiveMember_woe +</span></span>
<span id="cb111-292"><a href="#cb111-292" aria-hidden="true" tabindex="-1"></a><span class="st">  Geography_woe + </span></span>
<span id="cb111-293"><a href="#cb111-293" aria-hidden="true" tabindex="-1"></a><span class="st">  Gender_woe +</span></span>
<span id="cb111-294"><a href="#cb111-294" aria-hidden="true" tabindex="-1"></a><span class="st">  EstimatedSalary_woe</span></span>
<span id="cb111-295"><a href="#cb111-295" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb111-296"><a href="#cb111-296" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="at">formula =</span> <span class="fu">as.formula</span>(formula), <span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">"logit"</span>), <span class="at">data =</span> mod)</span>
<span id="cb111-297"><a href="#cb111-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-298"><a href="#cb111-298" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelo)</span>
<span id="cb111-299"><a href="#cb111-299" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-302"><a href="#cb111-302" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-303"><a href="#cb111-303" aria-hidden="true" tabindex="-1"></a>nom_vars <span class="ot">&lt;-</span> <span class="fu">all.vars</span>(<span class="fu">terms</span>(modelo))[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb111-304"><a href="#cb111-304" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">cor</span>(<span class="fu">setDT</span>(mod)[, ..nom_vars])</span>
<span id="cb111-305"><a href="#cb111-305" aria-hidden="true" tabindex="-1"></a>res</span>
<span id="cb111-306"><a href="#cb111-306" aria-hidden="true" tabindex="-1"></a><span class="fu">eigen</span>(res)</span>
<span id="cb111-307"><a href="#cb111-307" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>( <span class="fu">head</span>(<span class="fu">eigen</span>(res)<span class="sc">$</span>values,<span class="dv">1</span>) <span class="sc">/</span> <span class="fu">tail</span>(<span class="fu">eigen</span>(res)<span class="sc">$</span>values,<span class="dv">1</span>)) <span class="co"># calculo IC &gt; 5 indicios multicolinealidad</span></span>
<span id="cb111-308"><a href="#cb111-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-309"><a href="#cb111-309" aria-hidden="true" tabindex="-1"></a>df_bineed[, Y<span class="sc">:</span><span class="er">=</span> modelo<span class="sc">$</span>coefficients[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">Reduce</span>(<span class="st">`</span><span class="at">+</span><span class="st">`</span>, <span class="fu">Map</span>(<span class="cf">function</span>(var, coef) <span class="fu">get</span>(var) <span class="sc">*</span> coef, <span class="fu">names</span>(modelo<span class="sc">$</span>coefficients[<span class="sc">-</span><span class="dv">1</span>]), modelo<span class="sc">$</span>coefficients[<span class="sc">-</span><span class="dv">1</span>]))]</span>
<span id="cb111-310"><a href="#cb111-310" aria-hidden="true" tabindex="-1"></a>df_bineed[, RL <span class="sc">:</span><span class="er">=</span> (<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(Y)))]</span>
<span id="cb111-311"><a href="#cb111-311" aria-hidden="true" tabindex="-1"></a><span class="co">#quantile(df_bineed$RL, probs = seq(0 , 1, by = 0.01))</span></span>
<span id="cb111-312"><a href="#cb111-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-313"><a href="#cb111-313" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> df_bineed[ModVal <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> Exited <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)]</span>
<span id="cb111-314"><a href="#cb111-314" aria-hidden="true" tabindex="-1"></a>val <span class="ot">&lt;-</span> df_bineed[ModVal <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb111-315"><a href="#cb111-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-316"><a href="#cb111-316" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimación  Probabilidades</span></span>
<span id="cb111-317"><a href="#cb111-317" aria-hidden="true" tabindex="-1"></a>res_mod <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">Var =</span> mod<span class="sc">$</span>Exited, <span class="at">RL =</span> mod<span class="sc">$</span>RL)</span>
<span id="cb111-318"><a href="#cb111-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-319"><a href="#cb111-319" aria-hidden="true" tabindex="-1"></a>res_val <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">Var =</span> val<span class="sc">$</span>Exited, <span class="at">RL =</span> val<span class="sc">$</span>RL)</span>
<span id="cb111-320"><a href="#cb111-320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-321"><a href="#cb111-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-322"><a href="#cb111-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-325"><a href="#cb111-325" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-326"><a href="#cb111-326" aria-hidden="true" tabindex="-1"></a><span class="co"># Gráficas ROC</span></span>
<span id="cb111-327"><a href="#cb111-327" aria-hidden="true" tabindex="-1"></a><span class="co">#library(pROC)</span></span>
<span id="cb111-328"><a href="#cb111-328" aria-hidden="true" tabindex="-1"></a>objroc1 <span class="ot">&lt;-</span> <span class="fu">roc</span>(res_mod<span class="sc">$</span>Var, res_mod<span class="sc">$</span>RL, <span class="at">auc=</span>T, <span class="at">ci=</span>T)</span>
<span id="cb111-329"><a href="#cb111-329" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(objroc1, <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">xlab=</span><span class="st">"1 - Especificidad"</span>, <span class="at">ylab=</span><span class="st">"Sensibilidad"</span>, <span class="at">main=</span><span class="st">"Comparación curvas ROC"</span>, <span class="at">legacy.axes =</span> <span class="cn">TRUE</span>)</span>
<span id="cb111-330"><a href="#cb111-330" aria-hidden="true" tabindex="-1"></a>objroc2 <span class="ot">&lt;-</span> <span class="fu">roc</span>(res_val<span class="sc">$</span>Var, res_val<span class="sc">$</span>RL, <span class="at">auc=</span>T, <span class="at">ci=</span>T)</span>
<span id="cb111-331"><a href="#cb111-331" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(objroc2, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb111-332"><a href="#cb111-332" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomright"</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"Modelamiento"</span>,<span class="fu">round</span>(objroc1<span class="sc">$</span>auc, <span class="dv">3</span>)), <span class="fu">paste</span>(<span class="st">"Validación"</span>, <span class="fu">round</span>(objroc2<span class="sc">$</span>auc, <span class="dv">3</span>))), <span class="at">col=</span><span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>), <span class="at">lwd=</span><span class="fl">0.5</span>, <span class="at">title =</span> <span class="st">"AUC-ROC"</span>)</span>
<span id="cb111-333"><a href="#cb111-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-334"><a href="#cb111-334" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-335"><a href="#cb111-335" aria-hidden="true" tabindex="-1"></a>Con la librería <span class="in">`scorecard`</span> se ha alcanzado un AUC-ROC de validación de <span class="in">`r round(objroc2$auc, 3)`</span></span>
<span id="cb111-336"><a href="#cb111-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-337"><a href="#cb111-337" aria-hidden="true" tabindex="-1"></a><span class="fu">## Ensamble</span></span>
<span id="cb111-338"><a href="#cb111-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-339"><a href="#cb111-339" aria-hidden="true" tabindex="-1"></a>Creamos y damos formato necesario para utilizar <span class="in">`h2o`</span>, nota en esta ocasión trabajaremos con las variables binneadas de forma personalizada</span>
<span id="cb111-340"><a href="#cb111-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-343"><a href="#cb111-343" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-344"><a href="#cb111-344" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejecución del Ensamble</span></span>
<span id="cb111-345"><a href="#cb111-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-346"><a href="#cb111-346" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(h2o)</span>
<span id="cb111-347"><a href="#cb111-347" aria-hidden="true" tabindex="-1"></a><span class="fu">h2o.init</span>(<span class="at">ip =</span> <span class="st">"localhost"</span>, <span class="at">nthreads =</span> <span class="dv">2</span>, <span class="at">max_mem_size =</span> <span class="st">"5G"</span>)</span>
<span id="cb111-348"><a href="#cb111-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-349"><a href="#cb111-349" aria-hidden="true" tabindex="-1"></a><span class="co"># Establecemos los datos en el formato adecuado</span></span>
<span id="cb111-350"><a href="#cb111-350" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Exited"</span>, <span class="st">"prbm_NumOfProducts"</span>, <span class="st">"prbm_Age"</span>, <span class="st">"prbm_IsActiveMember"</span>, <span class="st">"prbm_Geography"</span>, <span class="st">"prbm_Gender"</span>, <span class="st">"prbm_EstimatedSalary"</span>)</span>
<span id="cb111-351"><a href="#cb111-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-352"><a href="#cb111-352" aria-hidden="true" tabindex="-1"></a>mod_em <span class="ot">&lt;-</span> <span class="fu">as.h2o</span>(<span class="at">x =</span> <span class="fu">setDT</span>(mod)[, vars, <span class="at">with =</span> <span class="cn">FALSE</span>])</span>
<span id="cb111-353"><a href="#cb111-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-354"><a href="#cb111-354" aria-hidden="true" tabindex="-1"></a><span class="co"># Identificamos predictores y respuesta</span></span>
<span id="cb111-355"><a href="#cb111-355" aria-hidden="true" tabindex="-1"></a>y_em <span class="ot">&lt;-</span> <span class="st">"Exited"</span>; x_em <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(mod_em), y_em)</span>
<span id="cb111-356"><a href="#cb111-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-357"><a href="#cb111-357" aria-hidden="true" tabindex="-1"></a><span class="co"># Para la clasificación binaria, la respuesta debe ser un factor </span></span>
<span id="cb111-358"><a href="#cb111-358" aria-hidden="true" tabindex="-1"></a>mod_em[,y_em] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(mod_em[,y_em])</span>
<span id="cb111-359"><a href="#cb111-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-360"><a href="#cb111-360" aria-hidden="true" tabindex="-1"></a><span class="co"># Numero de CV folds </span></span>
<span id="cb111-361"><a href="#cb111-361" aria-hidden="true" tabindex="-1"></a>nfolds <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb111-362"><a href="#cb111-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-363"><a href="#cb111-363" aria-hidden="true" tabindex="-1"></a><span class="co"># Generaremos el ensamble con 3 modelos (RF + GLM + GBM)</span></span>
<span id="cb111-364"><a href="#cb111-364" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-365"><a href="#cb111-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-366"><a href="#cb111-366" aria-hidden="true" tabindex="-1"></a><span class="fu">## Random Forest</span></span>
<span id="cb111-369"><a href="#cb111-369" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-370"><a href="#cb111-370" aria-hidden="true" tabindex="-1"></a><span class="co"># Train &amp; Cross- validate a RF</span></span>
<span id="cb111-371"><a href="#cb111-371" aria-hidden="true" tabindex="-1"></a>my_rf <span class="ot">&lt;-</span> <span class="fu">h2o.randomForest</span>(<span class="at">x =</span> x_em,</span>
<span id="cb111-372"><a href="#cb111-372" aria-hidden="true" tabindex="-1"></a>                          <span class="at">y =</span> y_em,</span>
<span id="cb111-373"><a href="#cb111-373" aria-hidden="true" tabindex="-1"></a>                          <span class="at">model_id =</span> <span class="st">"RF"</span>,</span>
<span id="cb111-374"><a href="#cb111-374" aria-hidden="true" tabindex="-1"></a>                          <span class="at">training_frame =</span> mod_em,</span>
<span id="cb111-375"><a href="#cb111-375" aria-hidden="true" tabindex="-1"></a>                          <span class="at">ntrees =</span> <span class="dv">300</span>,</span>
<span id="cb111-376"><a href="#cb111-376" aria-hidden="true" tabindex="-1"></a>                          <span class="at">min_rows =</span> <span class="dv">50</span>,</span>
<span id="cb111-377"><a href="#cb111-377" aria-hidden="true" tabindex="-1"></a>                          <span class="at">mtries =</span> <span class="dv">5</span>,</span>
<span id="cb111-378"><a href="#cb111-378" aria-hidden="true" tabindex="-1"></a>                          <span class="at">nfolds =</span> nfolds,</span>
<span id="cb111-379"><a href="#cb111-379" aria-hidden="true" tabindex="-1"></a>                          <span class="at">fold_assignment =</span> <span class="st">"Stratified"</span>,</span>
<span id="cb111-380"><a href="#cb111-380" aria-hidden="true" tabindex="-1"></a>                          <span class="at">keep_cross_validation_predictions =</span> <span class="cn">TRUE</span>,</span>
<span id="cb111-381"><a href="#cb111-381" aria-hidden="true" tabindex="-1"></a>                          <span class="at">seed =</span> <span class="dv">95</span>)</span>
<span id="cb111-382"><a href="#cb111-382" aria-hidden="true" tabindex="-1"></a><span class="fu">h2o.confusionMatrix</span>(my_rf)</span>
<span id="cb111-383"><a href="#cb111-383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-384"><a href="#cb111-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-385"><a href="#cb111-385" aria-hidden="true" tabindex="-1"></a><span class="fu">## Gradient Boosting Machine</span></span>
<span id="cb111-388"><a href="#cb111-388" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-389"><a href="#cb111-389" aria-hidden="true" tabindex="-1"></a><span class="co"># Train &amp; Cross-validate a GBM</span></span>
<span id="cb111-390"><a href="#cb111-390" aria-hidden="true" tabindex="-1"></a>my_gbm <span class="ot">&lt;-</span> <span class="fu">h2o.gbm</span>(<span class="at">x =</span> x_em,</span>
<span id="cb111-391"><a href="#cb111-391" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> y_em,</span>
<span id="cb111-392"><a href="#cb111-392" aria-hidden="true" tabindex="-1"></a>                  <span class="at">model_id =</span> <span class="st">"GBM"</span>,</span>
<span id="cb111-393"><a href="#cb111-393" aria-hidden="true" tabindex="-1"></a>                  <span class="at">training_frame =</span> mod_em,</span>
<span id="cb111-394"><a href="#cb111-394" aria-hidden="true" tabindex="-1"></a>                  <span class="at">distribution =</span> <span class="st">"bernoulli"</span>,</span>
<span id="cb111-395"><a href="#cb111-395" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ntrees =</span> <span class="dv">300</span>,</span>
<span id="cb111-396"><a href="#cb111-396" aria-hidden="true" tabindex="-1"></a>                  <span class="at">max_depth =</span> <span class="dv">5</span>,</span>
<span id="cb111-397"><a href="#cb111-397" aria-hidden="true" tabindex="-1"></a>                  <span class="at">min_rows =</span> <span class="dv">50</span>,</span>
<span id="cb111-398"><a href="#cb111-398" aria-hidden="true" tabindex="-1"></a>                  <span class="at">learn_rate =</span> <span class="fl">0.02</span>,</span>
<span id="cb111-399"><a href="#cb111-399" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nfolds =</span> nfolds,</span>
<span id="cb111-400"><a href="#cb111-400" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fold_assignment =</span> <span class="st">"Stratified"</span>,</span>
<span id="cb111-401"><a href="#cb111-401" aria-hidden="true" tabindex="-1"></a>                  <span class="at">keep_cross_validation_predictions =</span> <span class="cn">TRUE</span>,</span>
<span id="cb111-402"><a href="#cb111-402" aria-hidden="true" tabindex="-1"></a>                  <span class="at">seed =</span> <span class="dv">95</span>)</span>
<span id="cb111-403"><a href="#cb111-403" aria-hidden="true" tabindex="-1"></a><span class="fu">h2o.confusionMatrix</span>(my_gbm)</span>
<span id="cb111-404"><a href="#cb111-404" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-405"><a href="#cb111-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-406"><a href="#cb111-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-407"><a href="#cb111-407" aria-hidden="true" tabindex="-1"></a><span class="fu">## Regresión Logística</span></span>
<span id="cb111-410"><a href="#cb111-410" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-411"><a href="#cb111-411" aria-hidden="true" tabindex="-1"></a><span class="co"># Train &amp; Cross-validate a GLM</span></span>
<span id="cb111-412"><a href="#cb111-412" aria-hidden="true" tabindex="-1"></a>my_glm <span class="ot">&lt;-</span> <span class="fu">h2o.glm</span>(<span class="at">x =</span> x_em,</span>
<span id="cb111-413"><a href="#cb111-413" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> y_em,</span>
<span id="cb111-414"><a href="#cb111-414" aria-hidden="true" tabindex="-1"></a>                  <span class="at">model_id =</span> <span class="st">"GLM"</span>,</span>
<span id="cb111-415"><a href="#cb111-415" aria-hidden="true" tabindex="-1"></a>                  <span class="at">training_frame =</span> mod_em,</span>
<span id="cb111-416"><a href="#cb111-416" aria-hidden="true" tabindex="-1"></a>                  <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="co"># penaliza inclusión excesiva de variables</span></span>
<span id="cb111-417"><a href="#cb111-417" aria-hidden="true" tabindex="-1"></a>                  <span class="at">remove_collinear_columns =</span> <span class="cn">TRUE</span>,</span>
<span id="cb111-418"><a href="#cb111-418" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nfolds =</span> nfolds,</span>
<span id="cb111-419"><a href="#cb111-419" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fold_assignment =</span> <span class="st">"Stratified"</span>,</span>
<span id="cb111-420"><a href="#cb111-420" aria-hidden="true" tabindex="-1"></a>                  <span class="at">keep_cross_validation_predictions =</span> <span class="cn">TRUE</span>,</span>
<span id="cb111-421"><a href="#cb111-421" aria-hidden="true" tabindex="-1"></a>                  <span class="at">seed =</span> <span class="dv">95</span>)</span>
<span id="cb111-422"><a href="#cb111-422" aria-hidden="true" tabindex="-1"></a><span class="fu">h2o.confusionMatrix</span>(my_glm)</span>
<span id="cb111-423"><a href="#cb111-423" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-424"><a href="#cb111-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-425"><a href="#cb111-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-426"><a href="#cb111-426" aria-hidden="true" tabindex="-1"></a><span class="fu">## Ensamble RF + GBM</span></span>
<span id="cb111-429"><a href="#cb111-429" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-430"><a href="#cb111-430" aria-hidden="true" tabindex="-1"></a><span class="co"># Train ensamble</span></span>
<span id="cb111-431"><a href="#cb111-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-432"><a href="#cb111-432" aria-hidden="true" tabindex="-1"></a>e1m <span class="ot">&lt;-</span> <span class="fu">h2o.stackedEnsemble</span>(<span class="at">x =</span> x_em,</span>
<span id="cb111-433"><a href="#cb111-433" aria-hidden="true" tabindex="-1"></a>                           <span class="at">y =</span> y_em,</span>
<span id="cb111-434"><a href="#cb111-434" aria-hidden="true" tabindex="-1"></a>                           <span class="at">training_frame =</span> mod_em,</span>
<span id="cb111-435"><a href="#cb111-435" aria-hidden="true" tabindex="-1"></a>                           <span class="at">model_id =</span> <span class="st">"Ensamble_1m"</span>,</span>
<span id="cb111-436"><a href="#cb111-436" aria-hidden="true" tabindex="-1"></a>                           <span class="at">metalearner_algorithm =</span> <span class="st">"deeplearning"</span>,</span>
<span id="cb111-437"><a href="#cb111-437" aria-hidden="true" tabindex="-1"></a>                           <span class="at">base_models =</span> <span class="fu">list</span>(my_rf, my_gbm))</span>
<span id="cb111-438"><a href="#cb111-438" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-439"><a href="#cb111-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-440"><a href="#cb111-440" aria-hidden="true" tabindex="-1"></a><span class="fu">## Ensamble RF + RL</span></span>
<span id="cb111-443"><a href="#cb111-443" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-444"><a href="#cb111-444" aria-hidden="true" tabindex="-1"></a>e2m <span class="ot">&lt;-</span> <span class="fu">h2o.stackedEnsemble</span>(<span class="at">x =</span> x_em,</span>
<span id="cb111-445"><a href="#cb111-445" aria-hidden="true" tabindex="-1"></a>                           <span class="at">y =</span> y_em,</span>
<span id="cb111-446"><a href="#cb111-446" aria-hidden="true" tabindex="-1"></a>                           <span class="at">training_frame =</span> mod_em,</span>
<span id="cb111-447"><a href="#cb111-447" aria-hidden="true" tabindex="-1"></a>                           <span class="at">model_id =</span> <span class="st">"Ensamble_2m"</span>,</span>
<span id="cb111-448"><a href="#cb111-448" aria-hidden="true" tabindex="-1"></a>                           <span class="at">metalearner_algorithm =</span> <span class="st">"deeplearning"</span>,</span>
<span id="cb111-449"><a href="#cb111-449" aria-hidden="true" tabindex="-1"></a>                           <span class="at">base_models =</span> <span class="fu">list</span>(my_rf, my_glm))</span>
<span id="cb111-450"><a href="#cb111-450" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-451"><a href="#cb111-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-452"><a href="#cb111-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-453"><a href="#cb111-453" aria-hidden="true" tabindex="-1"></a>Ensamble RF + RL + GBM </span>
<span id="cb111-456"><a href="#cb111-456" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-457"><a href="#cb111-457" aria-hidden="true" tabindex="-1"></a>e3m <span class="ot">&lt;-</span> <span class="fu">h2o.stackedEnsemble</span>(<span class="at">x =</span> x_em,</span>
<span id="cb111-458"><a href="#cb111-458" aria-hidden="true" tabindex="-1"></a>                           <span class="at">y =</span> y_em,</span>
<span id="cb111-459"><a href="#cb111-459" aria-hidden="true" tabindex="-1"></a>                           <span class="at">training_frame =</span> mod_em,</span>
<span id="cb111-460"><a href="#cb111-460" aria-hidden="true" tabindex="-1"></a>                           <span class="at">model_id =</span> <span class="st">"Ensamble3m"</span>,</span>
<span id="cb111-461"><a href="#cb111-461" aria-hidden="true" tabindex="-1"></a>                           <span class="at">metalearner_algorithm =</span> <span class="st">"deeplearning"</span>,</span>
<span id="cb111-462"><a href="#cb111-462" aria-hidden="true" tabindex="-1"></a>                           <span class="at">base_models =</span> <span class="fu">list</span>(my_rf, my_gbm, my_glm))</span>
<span id="cb111-463"><a href="#cb111-463" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-464"><a href="#cb111-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-465"><a href="#cb111-465" aria-hidden="true" tabindex="-1"></a><span class="fu">## Predicciones </span></span>
<span id="cb111-468"><a href="#cb111-468" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-469"><a href="#cb111-469" aria-hidden="true" tabindex="-1"></a><span class="co"># Realizamos los predicciones sobre la muestra de modelamiento / validación</span></span>
<span id="cb111-470"><a href="#cb111-470" aria-hidden="true" tabindex="-1"></a>mod_em <span class="ot">&lt;-</span> <span class="fu">as.h2o</span>(<span class="at">x =</span> <span class="fu">setDT</span>(mod)[, vars, <span class="at">with =</span> <span class="cn">FALSE</span>])</span>
<span id="cb111-471"><a href="#cb111-471" aria-hidden="true" tabindex="-1"></a>val_em <span class="ot">&lt;-</span> <span class="fu">as.h2o</span>(<span class="at">x =</span> <span class="fu">setDT</span>(val)[, vars, <span class="at">with =</span> <span class="cn">FALSE</span>])</span>
<span id="cb111-472"><a href="#cb111-472" aria-hidden="true" tabindex="-1"></a>mod_em[,y_em] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(mod_em[, y_em])</span>
<span id="cb111-473"><a href="#cb111-473" aria-hidden="true" tabindex="-1"></a>val_em[,y_em] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(val_em[, y_em])</span>
<span id="cb111-474"><a href="#cb111-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-475"><a href="#cb111-475" aria-hidden="true" tabindex="-1"></a>res_f <span class="ot">&lt;-</span> <span class="cf">function</span>(valida, resul){</span>
<span id="cb111-476"><a href="#cb111-476" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Exited =</span> valida<span class="sc">$</span>Exited,</span>
<span id="cb111-477"><a href="#cb111-477" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Exited_p =</span> <span class="fu">as.data.frame</span>(resul)[,<span class="dv">3</span>],<span class="dv">0</span>)</span>
<span id="cb111-478"><a href="#cb111-478" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb111-479"><a href="#cb111-479" aria-hidden="true" tabindex="-1"></a>} </span>
<span id="cb111-480"><a href="#cb111-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-481"><a href="#cb111-481" aria-hidden="true" tabindex="-1"></a>roc_graf <span class="ot">&lt;-</span> <span class="cf">function</span>(res_mod, res_val, <span class="at">name=</span><span class="st">""</span>){</span>
<span id="cb111-482"><a href="#cb111-482" aria-hidden="true" tabindex="-1"></a>objroc1 <span class="ot">&lt;-</span> <span class="fu">roc</span>(res_mod<span class="sc">$</span>Exited, res_mod<span class="sc">$</span>Exited_p, <span class="at">auc=</span>T, <span class="at">ci=</span>T)</span>
<span id="cb111-483"><a href="#cb111-483" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(objroc1, <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">xlab=</span><span class="st">"1 - Especificidad"</span>, <span class="at">ylab=</span><span class="st">"Sensibilidad"</span>, <span class="at">main=</span><span class="fu">paste</span>(<span class="st">"Comparación curvas ROC"</span>,name), <span class="at">legacy.axes =</span> <span class="cn">TRUE</span>)</span>
<span id="cb111-484"><a href="#cb111-484" aria-hidden="true" tabindex="-1"></a>objroc2 <span class="ot">&lt;-</span> <span class="fu">roc</span>(res_val<span class="sc">$</span>Exited, res_val<span class="sc">$</span>Exited_p, <span class="at">auc=</span>T, <span class="at">ci=</span>T)</span>
<span id="cb111-485"><a href="#cb111-485" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(objroc2, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb111-486"><a href="#cb111-486" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomright"</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"Modelamiento"</span>,<span class="fu">round</span>(objroc1<span class="sc">$</span>auc, <span class="dv">3</span>)), <span class="fu">paste</span>(<span class="st">"Validación"</span>, <span class="fu">round</span>(objroc2<span class="sc">$</span>auc, <span class="dv">3</span>))), <span class="at">col=</span><span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>), <span class="at">lwd=</span><span class="fl">0.5</span>, <span class="at">title =</span> <span class="st">"AUC-ROC"</span>)</span>
<span id="cb111-487"><a href="#cb111-487" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb111-488"><a href="#cb111-488" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-489"><a href="#cb111-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-490"><a href="#cb111-490" aria-hidden="true" tabindex="-1"></a><span class="fu">## Curva ROC RF</span></span>
<span id="cb111-493"><a href="#cb111-493" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-494"><a href="#cb111-494" aria-hidden="true" tabindex="-1"></a><span class="co"># Random Forest</span></span>
<span id="cb111-495"><a href="#cb111-495" aria-hidden="true" tabindex="-1"></a>mod_rf <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(mod, <span class="fu">h2o.predict</span>(my_rf, <span class="at">newdata =</span> mod_em)))</span>
<span id="cb111-496"><a href="#cb111-496" aria-hidden="true" tabindex="-1"></a>val_rf <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(val, <span class="fu">h2o.predict</span>(my_rf, <span class="at">newdata =</span> val_em)))</span>
<span id="cb111-497"><a href="#cb111-497" aria-hidden="true" tabindex="-1"></a><span class="fu">roc_graf</span>(mod_rf,val_rf, <span class="st">"RF"</span>)</span>
<span id="cb111-498"><a href="#cb111-498" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-499"><a href="#cb111-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-500"><a href="#cb111-500" aria-hidden="true" tabindex="-1"></a><span class="fu">## Curva ROC RL</span></span>
<span id="cb111-503"><a href="#cb111-503" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-504"><a href="#cb111-504" aria-hidden="true" tabindex="-1"></a><span class="co"># Regresión Logística</span></span>
<span id="cb111-505"><a href="#cb111-505" aria-hidden="true" tabindex="-1"></a>mod_glm <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(mod, <span class="fu">h2o.predict</span>(my_glm, <span class="at">newdata =</span> mod_em)))</span>
<span id="cb111-506"><a href="#cb111-506" aria-hidden="true" tabindex="-1"></a>val_glm <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(val, <span class="fu">h2o.predict</span>(my_glm, <span class="at">newdata =</span> val_em)))</span>
<span id="cb111-507"><a href="#cb111-507" aria-hidden="true" tabindex="-1"></a><span class="fu">roc_graf</span>(mod_glm,val_glm, <span class="st">"Regresión Logística"</span>)</span>
<span id="cb111-508"><a href="#cb111-508" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-509"><a href="#cb111-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-510"><a href="#cb111-510" aria-hidden="true" tabindex="-1"></a><span class="fu">## Curva ROC GBM</span></span>
<span id="cb111-513"><a href="#cb111-513" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-514"><a href="#cb111-514" aria-hidden="true" tabindex="-1"></a><span class="co"># Gradient Boosting </span></span>
<span id="cb111-515"><a href="#cb111-515" aria-hidden="true" tabindex="-1"></a>mod_gbm <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(mod, <span class="fu">h2o.predict</span>(my_gbm, <span class="at">newdata =</span> mod_em)))</span>
<span id="cb111-516"><a href="#cb111-516" aria-hidden="true" tabindex="-1"></a>val_gbm <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(val, <span class="fu">h2o.predict</span>(my_gbm, <span class="at">newdata =</span> val_em)))</span>
<span id="cb111-517"><a href="#cb111-517" aria-hidden="true" tabindex="-1"></a><span class="fu">roc_graf</span>(mod_gbm,val_gbm, <span class="st">"Gradient Boosting"</span>)</span>
<span id="cb111-518"><a href="#cb111-518" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-519"><a href="#cb111-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-520"><a href="#cb111-520" aria-hidden="true" tabindex="-1"></a><span class="fu">## Curva ROC RF + GBM</span></span>
<span id="cb111-523"><a href="#cb111-523" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-524"><a href="#cb111-524" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensamble RF + GBM</span></span>
<span id="cb111-525"><a href="#cb111-525" aria-hidden="true" tabindex="-1"></a>mod_e1m <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(mod, <span class="fu">h2o.predict</span>(e1m, <span class="at">newdata =</span> mod_em)))</span>
<span id="cb111-526"><a href="#cb111-526" aria-hidden="true" tabindex="-1"></a>val_e1m <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(val, <span class="fu">h2o.predict</span>(e1m, <span class="at">newdata =</span> val_em)))</span>
<span id="cb111-527"><a href="#cb111-527" aria-hidden="true" tabindex="-1"></a><span class="fu">roc_graf</span>(mod_e1m,val_e1m, <span class="st">"Ensamble RF + GBM"</span>)</span>
<span id="cb111-528"><a href="#cb111-528" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-529"><a href="#cb111-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-530"><a href="#cb111-530" aria-hidden="true" tabindex="-1"></a><span class="fu">## Curva ROC RF + RL</span></span>
<span id="cb111-533"><a href="#cb111-533" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-534"><a href="#cb111-534" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensamble GLM +RF</span></span>
<span id="cb111-535"><a href="#cb111-535" aria-hidden="true" tabindex="-1"></a>mod_e2m <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(mod, <span class="fu">h2o.predict</span>(e2m, <span class="at">newdata =</span> mod_em)))</span>
<span id="cb111-536"><a href="#cb111-536" aria-hidden="true" tabindex="-1"></a>val_e2m <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(val, <span class="fu">h2o.predict</span>(e2m, <span class="at">newdata =</span> val_em)))</span>
<span id="cb111-537"><a href="#cb111-537" aria-hidden="true" tabindex="-1"></a><span class="fu">roc_graf</span>(mod_e2m,val_e2m, <span class="st">"Ensamble RF + GLM(RL)"</span>)</span>
<span id="cb111-538"><a href="#cb111-538" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-539"><a href="#cb111-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-540"><a href="#cb111-540" aria-hidden="true" tabindex="-1"></a><span class="fu">## Curva ROC RL + RF + GBM</span></span>
<span id="cb111-543"><a href="#cb111-543" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb111-544"><a href="#cb111-544" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensamble GLM + RF + GBM</span></span>
<span id="cb111-545"><a href="#cb111-545" aria-hidden="true" tabindex="-1"></a>mod_e3m <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(mod, <span class="fu">h2o.predict</span>(e3m, <span class="at">newdata =</span> mod_em)))</span>
<span id="cb111-546"><a href="#cb111-546" aria-hidden="true" tabindex="-1"></a>val_e3m <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">res_f</span>(val, <span class="fu">h2o.predict</span>(e3m, <span class="at">newdata =</span> val_em)))</span>
<span id="cb111-547"><a href="#cb111-547" aria-hidden="true" tabindex="-1"></a><span class="fu">roc_graf</span>(mod_e3m,val_e3m, <span class="st">"Ensamble RF + GBM + GLM(RL)"</span>)</span>
<span id="cb111-548"><a href="#cb111-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-549"><a href="#cb111-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-550"><a href="#cb111-550" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb111-551"><a href="#cb111-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-552"><a href="#cb111-552" aria-hidden="true" tabindex="-1"></a><span class="fu"># Conclusiones </span></span>
<span id="cb111-553"><a href="#cb111-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-554"><a href="#cb111-554" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Notemos que en la mayoria de casos se ha alcanzado AUC-ROC $\geq 0.80$ sin embargo el mejor modelo es el Ensamble de Random Forest + Gradient Boosting Machine + GLM( Regresión Logística)  con una AUC-ROC validación de $0.85$. Sin embargo el modelo también se ve sometido a requerimientos y recursos propios del negocio por lo que puede quedarse fuera y se opte por un modelo menos costoso en cuestión de tiempo y recursos.</span>
<span id="cb111-555"><a href="#cb111-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-556"><a href="#cb111-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-557"><a href="#cb111-557" aria-hidden="true" tabindex="-1"></a><span class="fu"># Recomendaciones</span></span>
<span id="cb111-558"><a href="#cb111-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-559"><a href="#cb111-559" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>En esta ocasión no hemos recurrido a una automatización completa del proceso de creación del modelo por lo que se podría explorar la creación de ensambles partiendo de las variables binneadas por optimal binning. </span>
<span id="cb111-560"><a href="#cb111-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-561"><a href="#cb111-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-562"><a href="#cb111-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-563"><a href="#cb111-563" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copiar al portapapeles" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>